<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>UnsafeTermScanner</title>
<link rel="icon" href="data:,">
<style>
  :root{
    --bg: #0f1115;
    --panel:#151922;
    --text:#e6e6e6;
    --muted:#a8b0bf;
    --chip:#232a36;
    --chip-text:#e6e6e6;
    --chip-muted:#9aa4b6;
    --accent:#5aa3ff;
    --ok:#2fb170;
    --warn:#f5c451;
    --danger:#e35d6a;
    --border:#2b3442;
    --link:#75b4ff;
    --shadow:0 5px 20px rgba(0,0,0,.4)
  }
  [data-theme="light"]{
    --bg:#fafafa; --panel:#ffffff; --text:#0e1420; --muted:#465064; --chip:#f1f3f7;
    --chip-text:#0e1420; --chip-muted:#5c667a; --accent:#1d6fff; --ok:#0a9157; --warn:#c18b14;
    --danger:#c53b49; --border:#d8deea; --link:#0a66d9; --shadow:0 6px 18px rgba(0,0,0,.08)
  }
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
  header{position:sticky;top:0;z-index:10;background:var(--panel);border-bottom:1px solid var(--border);box-shadow:var(--shadow)}
  .bar{max-width:1100px;margin:0 auto;display:flex;gap:16px;align-items:center;padding:10px 16px}
  .title{font-weight:700;letter-spacing:.2px}
  .spacer{flex:1}
  .toggle{display:inline-flex;gap:8px;align-items:center}
  .container{max-width:1400px;margin:18px auto;padding:0 16px 40px}
  .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:16px}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:10px;box-shadow:var(--shadow)}
  .panel h3{margin:0;padding:12px 14px;border-bottom:1px solid var(--border);font-size:15px}
  .panel .content{padding:12px 14px}
  label{font-size:13px;color:var(--muted)}
  input[type=file]{display:block;margin-top:8px}
  textarea{width:100%;height:90px;border:1px solid var(--border);background:var(--bg);color:var(--text);border-radius:8px;padding:8px}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{display:inline-flex;align-items:center;gap:8px;background:var(--chip);border:1px solid var(--border);color:var(--chip-text);padding:6px 10px;border-radius:999px}
  .chip small{color:var(--chip-muted);font-size:11px}
  .chip .btn{border:0;cursor:pointer;background:transparent;color:var(--muted);font-weight:700}
  .chip .btn:hover{color:var(--text)}
  .chip.auto{outline:1px dashed var(--accent)}
  .chip.recent{outline:1px dashed var(--warn)}
  .section-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
  select, input[type=number], input[type=text]{border:1px solid var(--border);background:var(--bg);color:var(--text);border-radius:8px;padding:6px 8px}
  .btn{border:1px solid var(--border);background:var(--chip);color:var(--text);padding:8px 12px;border-radius:8px;cursor:pointer}
  .btn.primary{background:var(--accent);border-color:transparent;color:#fff}
  .btn.ghost{background:transparent}
  .hint{color:var(--muted);font-size:12px}
  .kv{display:grid;grid-template-columns:auto 1fr;gap:6px 12px;font-size:13px}
  details{border-top:1px dashed var(--border);padding-top:8px;margin-top:8px}
  summary{cursor:pointer}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  .popover{position:absolute;z-index:50;min-width:360px;max-width:520px;background:var(--panel);border:1px solid var(--border);border-radius:10px;box-shadow:var(--shadow);padding:10px 10px}
  .list{max-height:220px;overflow:auto;margin:4px 0 0;padding:0}
  .list a{display:block;padding:6px 8px;color:var(--link);text-decoration:none;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .list a:hover{text-decoration:underline}
  .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:6px 0 10px}
  .pill{display:inline-flex;gap:6px;align-items:center;border:1px solid var(--border);padding:6px 10px;border-radius:999px;background:var(--chip);color:var(--chip-text)}
  .right{justify-content:flex-end}
  .mono{font-family:ui-monospace,SFMono-Regular,Consolas,Menlo,monospace}
  .small{font-size:12px}
  .muted{color:var(--muted)}
  .float-right{margin-left:auto}
  .danger{color:var(--danger)}
  .ok{color:var(--ok)}
  .warn{color:var(--warn)}
  .stack{display:grid;grid-template-columns:1fr;gap:12px}

  .dropzone{
  position:relative;border:2px dashed var(--border);border-radius:12px;
  padding:18px;text-align:center;background:var(--bg);
  transition:.15s border-color,.15s background
    }
    .dropzone.dragover{border-color:var(--accent);background:color-mix(in oklab, var(--accent) 12%, transparent)}
    .dz-inner{display:flex;gap:10px;justify-content:center;align-items:center;flex-wrap:wrap}
    .dz-title{font-weight:600}
    textarea{width:100%;max-width:100%}
    #dropZone input[type="file"]{ display:none !important; }
    #dropZone{ position:relative }
    #dropZone .dz-input{
    position:absolute; inset:0; width:100%; height:100%;
    opacity:0; cursor:pointer; /* not display:none */
    }
    .dz-inner{ display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap }
    .dz-title{ text-align:center }
    .chip { cursor:pointer }
    #backTop{
    position:fixed; right:16px; bottom:16px;
    padding:8px 12px; border-radius:999px; border:1px solid var(--border);
    background:var(--bg-elev); box-shadow:0 2px 8px rgb(0 0 0 / 12%);
    cursor:pointer; opacity:0; pointer-events:none; transition:opacity .15s ease;
    }
    #backTop.show{ opacity:1; pointer-events:auto; }
    .chip:hover{ outline:1px solid var(--border-strong); }

    /* full-bubble intent colors on +/- hover */
    .chip.will-add{
    background: color-mix(in oklab, var(--ok) 22%, transparent);
    border-color: var(--ok);
    }
    .chip.will-remove{
    background: color-mix(in oklab, var(--danger) 22%, transparent);
    border-color: var(--danger);
    }
    /* keep text readable */
    .chip.will-add b, .chip.will-add small,
    .chip.will-remove b, .chip.will-remove small{ color: inherit }
    #availFilters{ color: var(--muted); }
    /* two-column, sticky left */
    .container .grid{ display:grid; grid-template-columns: 420px 1fr; gap:16px }
    .panel.sidebar{ position:sticky; top:12px; align-self:start; height:fit-content }
    #outputPanel .two{ display:grid; grid-template-columns: 2fr 1fr; gap:12px }
    #outputTopRow{
        display:grid;
        grid-template-columns:minmax(0,2fr) minmax(220px,1fr);
        gap:12px;
        align-items:start;
    }
    #outputPanel textarea#csvOut{ width:100%; min-height:180px; }
    #blockedList .row{
        display:flex;
        gap:8px;
        align-items:flex-start;
        margin:4px 0;
        }

    #blockedList .row .pill.small{ flex:0 0 auto; margin-top:2px; min-width:90px; text-align:center }
    #blockedList .row a{ flex:1 1 auto; word-break:break-word; overflow-wrap:anywhere }
    #blockedList .pill.small{ min-width:84px; text-align:center }

</style>
</head>
<body>
<header>
  <div class="bar">
    <div class="title">UnsafeTermScanner</div>
    <div class="spacer"></div>
    <label class="toggle">
      <input id="themeToggle" type="checkbox" />
      <span class="hint">Light mode</span>
    </label>
  </div>
</header>

<div class="container">
    <div class="grid">
        <!-- LEFT: sticky sidebar -->
        <div class="panel sidebar">
          <h3>1) Input</h3>
          <div class="content">
            <div class="stack">
              <div>
                <label>Upload CSV/XLSX</label>
                <div id="dropZone" class="dropzone" tabindex="0" role="button" aria-label="Browse or drop a file">
                  <input id="file" class="dz-input" type="file" accept=".csv,.xlsx,.xls">
                  <div class="dz-inner">
                    <div class="dz-title"><b>Browse or drop CSV/XLSX here</b></div>
                    <button id="browseBtn" class="btn">Browse</button>
                  </div>
                </div>
                <div class="hint small">No upload. Processing happens in your browser.</div>
              </div>
      
              <div>
                <label>Or paste URLs / CSV rows</label>
                <textarea id="paste" placeholder="Paste URLs or a CSV snippet…"></textarea>
              </div>
            </div>
      
            <div class="toolbar">
              <button id="scanBtn" class="btn primary">Scan</button>
              <button id="clearBtn" class="btn">Clear</button>
              <div class="pill"><span class="muted small">Rows:</span> <b id="rowCount">0</b></div>
              <div class="pill"><span class="muted small">Domains:</span> <b id="domainCount">0</b></div>
              <div class="pill"><span class="muted small">Terms:</span> <b id="tokenCount">0</b></div>
            </div>
          </div>
      
          <h3>2) Settings</h3>
          <div class="content">
            <div class="two" style="margin-top:0">
              <div>
                <label>Minimum URLs per term</label>
                <input id="minUrls" type="number" min="1" value="2" />
                <div class="hint small">Set to 1 to see all.</div>
              </div>
              <div>
                <label>Sort “Available” by</label>
                <select id="sortAvailable">
                  <option value="alpha">Alphabetical</option>
                  <option value="freq">Frequency</option>
                  <option value="impact" selected>Impact</option>
                </select>
              </div>
            </div>
      
            <div class="two" style="margin-top:10px">
              <div>
                <label>Impact column (optional)</label>
                <select id="impactCol"><option value="">Auto-detect…</option></select>
                <div class="hint small">Looks for numeric columns like “impressions, failed, blocked, views, qty”.</div>
              </div>
              <div>
                <label>Add custom keyword</label>
                <div class="row">
                  <input id="customKey" type="text" placeholder="e.g., los-angeles" />
                  <button id="addCustom" class="btn">Add</button>
                </div>
              </div>
            </div>
      
            <div class="toolbar" style="margin-top:14px; justify-content:flex-start">
                <button id="createBtn" class="btn primary">Copy/Export</button>
              </div>              
          </div>
        </div>
      
        <!-- RIGHT: results column -->
        <div class="panel">
          <h3>3) Results</h3>
          <div class="content">
            <div id="emptyState" class="panel" style="padding:12px">
                <div class="content">
                  <div class="hint">Upload a CSV/XLSX or paste URLs to start building your custom term list.</div>
                </div>
              </div>
            <div class="section-header">
              <b>Included (<span id="includedCount">0</span>)</b>
              <div class="hint small">Auto from lexicon. Your additions append to the end.</div>
            </div>
            <div id="included" class="chips" aria-live="polite"></div>
      
            <div class="section-header" style="margin-top:12px">
                <b>Available (<span id="availableCount">0</span>)</b>
                <div class="row" style="gap:8px">
                  <button id="showAllAvail" class="btn ghost small">Show all</button>
                  <span id="availFilters" class="hint small"></span>
                </div>
              </div>              
            <div id="available" class="chips" aria-live="polite"></div>
      
            <div id="outputPanel" class="panel" style="margin-top:14px;display:none">
                <h3>Output</h3>
                <div class="content">
                  <div class="two" id="outputTopRow">
                    <div>
                      <label>Comma-separated</label>
                      <textarea id="csvOut" class="mono"></textarea>
                    </div>
                    <div>
                      <div class="kv">
                        <div class="muted">Unique URLs blocked:</div><div id="blockedUrlCount">0</div>
                        <div class="muted">Total impact blocked:</div><div id="blockedImpact">0</div>
                      </div>
                    </div>
                  </div>
              
                  <!-- full-width list below -->
                  <details id="blockedDetails" style="margin-top:10px">
                    <summary>Show blocked articles</summary>
                    <div id="blockedList"></div>
                  </details>
                </div>
              </div>              
      
            <div id="hoverBox" class="popover" style="display:none"></div>
          </div>
        </div>
      </div>      
</div>

<script>
/* ---------- Theme ---------- */
const themeToggle = document.getElementById('themeToggle');
(function initTheme(){
  const saved = localStorage.getItem('uts-theme');
  const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
  const isLight = saved ? saved==='light' : prefersLight;
  document.documentElement.setAttribute('data-theme', isLight ? 'light' : 'dark');
  themeToggle.checked = isLight;
})();
themeToggle.addEventListener('change', ()=>{
  const mode = themeToggle.checked ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', mode);
  localStorage.setItem('uts-theme', mode);
});

async function ensureXLSX(){
  if (window.XLSX) return true;
  const candidates = [
    './lib/xlsx.full.min.js',                                   // local vendored copy
    'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.2/xlsx.full.min.js',
    'https://unpkg.com/xlsx@0.20.2/dist/xlsx.full.min.js'
  ];
  for (const url of candidates){
    try{
      await new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src=url; s.async=true; s.onload=res; s.onerror=()=>rej();
        document.head.appendChild(s);
      });
      if (window.XLSX) return true;
    }catch{}
  }
  return false; // CSV-only fallback
}

function toggleEmptyState(){
  const hasData = state.rows.length>0;
  const empty = document.getElementById('emptyState');
  if (!empty) return;
  empty.style.display = hasData ? 'none' : 'block';
  // hide results sections when empty
  document.querySelectorAll('#included, #available, #outputPanel, .section-header')
    .forEach(n=>{ if (n.id!=='emptyState') n.style.display = hasData ? '' : 'none'; });
}



/* ---------- Lexicon load (with fallback) ---------- */
let LEX = null;
const FALLBACK_UNSAFE = {
  disasters:["wildfire","fire","earthquake","hurricane","tornado","flood","evacuation","smoke","eruption","tsunami","landslide","avalanche","blizzard","outage","blackout","collapse","explosion","derailment","crash","collision","spill","leak"],
  crime_violence:["shooting","stabbing","homicide","murder","assault","kidnapping","arson","riot","terrorism","bomb","hostage","threat"],
  legal:["subpoena","indictment","arrest","charges","lawsuit","litigation","conviction","trial","sentencing","appeal","fraud","bribery","corruption","money-laundering","racketeering","rico","misconduct","impeachment"],
  health_safety:["outbreak","pandemic","quarantine","contamination","recall","poisoning","toxin","radiation","hazmat","biohazard","overdose","opioid","fentanyl"],
  finance_instability:["bankruptcy","insolvency","default","foreclosure","eviction","layoff","strike","boycott"],
  politics_risk:["coup","insurrection","sedition","treason","crackdown","curfew","martial-law","ban","banned","protest","unrest"]
};
const NEUTRAL_SECTIONS_DEFAULT = new Set(["news","latest","live","update","story","video","photo","photos","gallery","podcast","column","opinion","analysis","feature","weather","nation","politics","business","sports","technology","tech","style","travel","food","health","science","world","local","metro","arts","entertainment","maps","data","interactive"]);
const STOP_DEFAULT = new Set(["the","and","for","but","nor","with","that","this","from","into","onto","about","over","under","after","before","since","until","while","when","what","how","why","are","were","was","been","being","have","has","had","do","does","did","on","in","to","of","by","at","as","per","via","a","an","is","it","its","their","our","your"]);
const MONTHS = new Set(["january","february","march","april","may","june","july","august","september","october","november","december"]);
const WEEKDAYS = new Set(["monday","tuesday","wednesday","thursday","friday","saturday","sunday"]);
const THREE_EXCEPTIONS = new Set(["war","ban","gas","flu","pox","sex","gun","die"]);
const VOWELS = new Set(["a","e","i","o","u","y"]);

async function loadLexicon(){
  try{
    const r = await fetch('unsafe_lexicon_v1.json', {cache:'no-store'});
    if (!r.ok) throw new Error('no lex json');
    const j = await r.json();
    LEX = {
      UNSAFE: new Set(Object.values(j.unsafe).flat()),
      NEUTRAL: new Set(j.neutral_sections || [...NEUTRAL_SECTIONS_DEFAULT]),
      STOP: new Set(j.stopwords || [...STOP_DEFAULT]),
      allowBrands: new Set(j.allowlist_brands || []),
      allowLocs: new Set(j.allowlist_locations || []),
      settings: j.morphology || {}
    };
  }catch{
    LEX = {
      UNSAFE: new Set(Object.values(FALLBACK_UNSAFE).flat()),
      NEUTRAL: NEUTRAL_SECTIONS_DEFAULT,
      STOP: STOP_DEFAULT,
      allowBrands: new Set(),
      allowLocs: new Set(),
      settings: { split_delimiters:["/","-","_","."], scan_hostname:false, include_query:false }
    };
  }
}
loadLexicon();

/* ---------- State ---------- */
const state = {
  rows: [],        // {urls:[string], domain:string, impact:number}
  tokens: new Map(), // token -> {freq:number, impact:number, domains:Set, samples:string[], rows:Set}
  includedSet: new Set(),   // selected for output
  includedOrder: [],        // display order
  availableSet: new Set(),  // candidates not included
  availableOrder: [],       // display order (changes via sort and appends)
  autoIncluded: new Set(),  // from UNSAFE lexicon
  urlRegex: /https?:\/\/[^\s"']+/ig,
  ignoreParams: new Set(["gclid","fbclid","mc_cid","mc_eid","utm_source","utm_medium","utm_campaign","utm_term","utm_content","utm_id","source","ref"])
};

/* ---------- DOM ---------- */
const el = (s)=>document.querySelector(s);
const fileInput = el('#file');
const pasteInput = el('#paste');

const scanBtn = el('#scanBtn');
const clearBtn = el('#clearBtn');
const rowCount = el('#rowCount');
const domainCount = el('#domainCount');
const tokenCount = el('#tokenCount');
const includedBox = el('#included');
const availableBox = el('#available');
const includedCount = el('#includedCount');
const availableCount = el('#availableCount');
const createBtn = el('#createBtn');
const outputPanel = el('#outputPanel');
const csvOut = el('#csvOut');
const blockedUrlCount = el('#blockedUrlCount');
const blockedImpact = el('#blockedImpact');
const blockedList = el('#blockedList');
const hoverBox = el('#hoverBox');

const minUrls = el('#minUrls');
const sortAvailable = el('#sortAvailable');
const impactCol = el('#impactCol');
const showAllAvail = el('#showAllAvail');
const availFilters = el('#availFilters');
const customKey = el('#customKey');
const addCustom = el('#addCustom');

const dropZone = el('#dropZone');
const browseBtn = el('#browseBtn');
const dzTitle = dropZone ? dropZone.querySelector('.dz-title') : null;


function rebuildAvailable(){
  state.availableSet.clear();
  const umin = Number(minUrls.value)||1;
  for (const [tok, rec] of state.tokens){
    if (state.includedSet.has(tok)) continue;
    const urlCount = rec.urls ? rec.urls.size : 0;
    if (urlCount < umin) continue;
    state.availableSet.add(tok);
  }
  sortAndRenderAvailable();
  updateStats();
  updateAvailFilters();
}


function updateAvailFilters(){
  const u = Number(minUrls.value)||1;
  const parts = [];
  if (u>1) parts.push(`≥${u} URLs`);
  availFilters.textContent = parts.join(' · ');
}

/* ---------- Utilities ---------- */
function asciiFold(s){
  return s.normalize ? s.normalize('NFKD').replace(/[\u0300-\u036f]/g,'') : s;
}
function baseForm(tok){
  // crude lemmatization
  if (tok.endsWith('ies')) return tok.slice(0,-3)+'y';
  if (tok.endsWith('ves')) return tok.slice(0,-3)+'f';
  if (tok.endsWith('ing') && tok.length>5) return tok.slice(0,-3);
  if (tok.endsWith('ed') && tok.length>4) return tok.slice(0,-2);
  if (tok.endsWith('s') && tok.length>3) return tok.slice(0,-1);
  return tok;
}
function isAllHex(s){
  return /^[a-f]+$/.test(s);
}
function hexBias(s){
  if (!s) return 0;
  let k=0;
  for (const c of s) if ("abcdef".includes(c)) k++;
  return k/s.length;
}
function hasVowel(s){
  for (const c of s) if (VOWELS.has(c)) return true;
  return false;
}
function isRepetition(s){
  // repeated motif length 1..3 or any triple char
  if (/(.)\1\1/.test(s)) return true;
  for (let m=1;m<=3;m++){
    if (s.length % m === 0){
      const rep = s.slice(0,m).repeat(s.length/m);
      if (rep===s) return true;
    }
  }
  return false;
}
function uniqPush(arr, val, cap=10){
  if (arr.includes(val)) return;
  if (arr.length<cap) arr.push(val);
}
function byAlpha(a,b){ return a.localeCompare(b); }
function urlPath(u){
  try{
    const x = new URL(u);
    return (x.pathname || '/') + (x.search || '') + (x.hash || '');
  }catch{ return u; }
}

/* ---------- Tokenization ---------- */
function extractUrlsFromRow(rowObj){
  const urls = new Set();
  // strings: search for http(s)://
  for (const v of Object.values(rowObj)){
    if (typeof v === 'string'){
      const matches = v.match(state.urlRegex);
      if (matches) for(const u of matches) urls.add(u);
    }
  }
  return [...urls];
}
function detectImpactColumn(headers, rows){
  // heuristic: find first numeric column with a friendly name
  const prefer = /(impressions|failed|blocked|views|view|qty|quantity|count|volume|reach|exposure)/i;
  let candidates = [];
  headers.forEach((h,i)=>{
    let numeric = 0, total = 0;
    for (const r of rows){
      const v = r[i];
      if (typeof v === 'number' && !Number.isNaN(v)){ numeric++; total++; }
      else if (typeof v === 'string' && v.trim()!=='' && !isNaN(Number(v))){ numeric++; total++; }
      else if (v==='' || v==null){ total++; }
      else { total++; }
    }
    if (numeric>0) candidates.push({index:i, header:h, score:(prefer.test(h)?2:1)+numeric/Math.max(1,rows.length)});
  });
  candidates.sort((a,b)=>b.score-a.score);
  return candidates[0] || null;
}
function normalizeTokensFromUrl(u, opts){
  let url;
  try{ url = new URL(u); }catch{ return []; }
  const set = new Set();

  let path = decodeURIComponent(url.pathname||'');
  const parts = path.split(/[\/\-_\.]+/);
  for (let p of parts) set.add(p);

  // Clean and filter
  const out = [];
  for (let t of set){
    t = asciiFold(String(t||'').toLowerCase());
    t = t.replace(/[^a-z\-]/g,'');           // letters and hyphen only
    if (!t) continue;
    if (LEX.NEUTRAL.has(t) || LEX.STOP.has(t) || MONTHS.has(t) || WEEKDAYS.has(t)) continue;
    if (LEX.allowBrands.has(t) || LEX.allowLocs.has(t)) continue;
    // if contains hyphen, also split into pieces so both "los-angeles" and "los","angeles" can appear
    const candidates = t.includes('-') ? [t, ...t.split('-')] : [t];
    for (let c of candidates){
      c = c.replace(/[^a-z]/g,'');
      if (!c) continue;
      let base = baseForm(c);
      // length rules
      if (base.length<4 && !THREE_EXCEPTIONS.has(base)) continue;
      if (base.length>24) continue;
      // noise rules
      if (!hasVowel(base) && !LEX.UNSAFE.has(base) && !THREE_EXCEPTIONS.has(base)) continue;
      if (isRepetition(base)) continue;
      if (isAllHex(base) || hexBias(base)>=0.8) continue;
      out.push(base);
    }
  }
  return [...new Set(out)];
}
    async function ensureXLSX(){
    if (window.XLSX) return true;
    const candidates = [
        './lib/xlsx.full.min.js', // local copy if you add it
        'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.2/xlsx.full.min.js',
        'https://unpkg.com/xlsx@0.20.2/dist/xlsx.full.min.js'
    ];
    for (const url of candidates){
        try{
        await new Promise((res,rej)=>{
            const s=document.createElement('script');
            s.src=url; s.async=true;
            s.onload=res; s.onerror=()=>rej(new Error('load fail '+url));
            document.head.appendChild(s);
        });
        if (window.XLSX) return true;
        }catch{}
    }
    return false; // XLSX unavailable → CSV-only mode
    }

/* ---------- Parsing pipeline ---------- */
    async function parseInput(){
    if (!LEX) await loadLexicon();

    function parseCSV(text){
        const rows=[]; let row=[], field='', inQ=false;
        for (let i=0;i<text.length;i++){
        const c=text[i], n=text[i+1];
        if (inQ){
            if (c==='"' && n==='"'){ field+='"'; i++; continue; }
            if (c==='"'){ inQ=false; continue; }
            field+=c; continue;
        }
        if (c==='"'){ inQ=true; continue; }
        if (c===','){ row.push(field); field=''; continue; }
        if (c==='\r'){ continue; }
        if (c==='\n'){ row.push(field); rows.push(row); row=[]; field=''; continue; }
        field+=c;
        }
        row.push(field); rows.push(row);
        return rows;
    }

    // reset
    state.rows = [];
    state.tokens.clear();
    state.includedSet.clear(); state.includedOrder.length=0;
    state.availableSet.clear(); state.availableOrder.length=0;
    state.autoIncluded.clear();

    let headers = [];
    let tableRows = [];

    // file
    if (fileInput.files && fileInput.files[0]){
        const f = fileInput.files[0];
        const name = f.name.toLowerCase();
        if (name.endsWith('.xlsx') || name.endsWith('.xls')){
        const ok = await ensureXLSX();
        if (!ok){ alert('XLSX parsing unavailable. Add ./lib/xlsx.full.min.js or upload CSV.'); updateStats(); render(); return; }
        const buf = await f.arrayBuffer();
        const wb = XLSX.read(buf, {type:'array'});
        wb.SheetNames.forEach(name=>{
            const sh = wb.Sheets[name];
            const json = XLSX.utils.sheet_to_json(sh, {header:1, raw:true, defval:''});
            if (!json.length) return;
            const h = json[0].map(x=>String(x??''));
            const rows = json.slice(1);
            if (!headers.length) headers = h;
            for (const r of rows){ while (r.length<headers.length) r.push(''); }
            tableRows.push(...rows);
        });
        }else{
        const text = await f.text();
        const arr = parseCSV(text);
        if (arr.length){
            const h = arr[0].map(x=>String(x??''));
            const rows = arr.slice(1);
            if (!headers.length) headers = h;
            for (const r of rows){ while (r.length<headers.length) r.push(''); }
            tableRows.push(...rows);
        }
        }
    }

    // paste
    const pasted = pasteInput.value.trim();
    if (pasted){
        const looksCSV = /,|".*?".*[,|\n]/s.test(pasted);
        if (looksCSV){
        const arr = parseCSV(pasted);
        if (arr.length){
            const h = arr[0].map(x=>String(x??''));
            const rows = arr.slice(1);
            if (!headers.length) headers = h;
            for (const r of rows){ while (r.length<headers.length) r.push(''); }
            tableRows.push(...rows);
        }
        }else{
        const h = ['url'];
        const rows = pasted.split(/\r?\n/).map(l=>[l.trim()]);
        if (!headers.length) headers = h;
        tableRows.push(...rows);
        }
    }

    if (!headers.length && !tableRows.length){ updateStats(); return; }

    // ---- Impact column detection (only numeric-eligible columns) ----
    function analyzeNumericColumns(headers, rows){
    const prefer = /(impressions|failed|blocked|views|view|qty|quantity|count|volume|reach|exposure)/i;
    const out=[];
    headers.forEach((h,i)=>{
        let numeric=0, checked=0;
        for (let k=0;k<Math.min(300, rows.length);k++){
        const v = rows[k][i];
        if (v===''||v==null){ checked++; continue; }
        if (typeof v==='number'){ numeric++; checked++; continue; }
        const n = Number(String(v).replace(/,/g,''));
        if (!Number.isNaN(n)){ numeric++; checked++; continue; }
        checked++;
        }
        if (numeric>0){
        const frac = numeric/Math.max(1,checked);
        out.push({i, h, frac, score:(prefer.test(h)?2:1)+frac});
        }
    });
    out.sort((a,b)=>b.score-a.score);
    return out;
    }
    let impactIdx = null;
    const numericEligible = analyzeNumericColumns(headers, tableRows);
    if (numericEligible.length){
    impactIdx = numericEligible[0].i;
    if (numericEligible.length === 1){
        impactCol.innerHTML = `<option value="${numericEligible[0].i}">${numericEligible[0].h}</option>`;
        impactCol.value = String(numericEligible[0].i);
        impactCol.disabled = true;
    }else{
        const opts = [`<option value="">Auto: ${numericEligible[0].h}</option>`]
        .concat(numericEligible.map(c=>`<option value="${c.i}">${c.h}</option>`));
        impactCol.innerHTML = opts.join('');
        impactCol.disabled = false;
    }
    }else{
    impactCol.innerHTML = `<option value="">Auto-detect…</option>`;
    impactCol.disabled = true;
    }

    // detect URL/keyword columns
    const urlCols = new Set();
        for (let i=0;i<headers.length;i++){
        let hits=0;
        for (let k=0;k<Math.min(50, tableRows.length);k++){
            const cell = tableRows[k][i];
            if (typeof cell==='string' && /https?:\/\//i.test(cell)) hits++;
        }
        if (hits>0) urlCols.add(i);
        }

    const keyCols = new Set();
    headers.forEach((h,i)=>{ if (/keyword|segment|tag|topic/i.test(h)) keyCols.add(i); });

    const opts = { scanHost:false, includeQuery:false };

    // rows → tokens
    tableRows.forEach((arr, idx)=>{
    const obj = {}; headers.forEach((h,i)=>obj[h]=arr[i]);

    // collect URLs from detected URL columns, else from any string cell
    let urls = [];
    if (urlCols.size){
        for (const c of urlCols){
        const v = arr[c];
        if (typeof v==='string'){
            const m = v.match(state.urlRegex);
            if (m) urls.push(...m);
        }
        }
    }else{
        for (const v of Object.values(obj)){
        if (typeof v==='string'){
            const m = v.match(state.urlRegex);
            if (m) urls.push(...m);
        }
        }
    }
    if (!urls.length){
        for (const v of arr){
        if (typeof v==='string' && /^https?:\/\//i.test(v.trim())) urls.push(v.trim());
        }
    }
    if (!urls.length) return;

    const primary = urls[0];
    let domain = '';
    try{ domain = new URL(primary).hostname.replace(/^www\./,''); }catch{}
    let imp = 0;
    const chosenImpactIdx = impactCol.value!=='' ? Number(impactCol.value) : impactIdx;
    if (chosenImpactIdx!=null){
        const v = arr[chosenImpactIdx];
        const num = typeof v==='number' ? v : Number(String(v).replace(/,/g,''));
        if (!Number.isNaN(num)) imp = num;
    }

    /* ---------- tokens ---------- */
    // Count unique URLs per token. Keywords affect row presence but not URL count.
    const perRowTokenSet = new Set(); // tokens present anywhere in this row

    // from URLs → add unique URL per token
    for (const u of urls){
        const toksArr = normalizeTokensFromUrl(u, opts);
        const uniq = new Set(toksArr);
        for (const t of uniq){
        if (!state.tokens.has(t)){
            state.tokens.set(t, {freq:0, impact:0, domains:new Set(), samples:[], rows:new Set(), urls:new Set()});
        }
        const rec = state.tokens.get(t);
        rec.urls.add(u);                 // used for “URLs” count
        perRowTokenSet.add(t);           // used for row presence
        }
    }

    // from keyword-like columns → row presence only
    for (const c of keyCols){
        const v = arr[c];
        if (typeof v === 'string' && v.trim()){
        v.split(/[,;\|]+/).forEach(piece=>{
            const toks2 = normalizeTokensFromUrl(String(piece), {scanHost:false, includeQuery:false});
            for (const t of new Set(toks2)) perRowTokenSet.add(t);
        });
        }
    }

    /* ---------- update token map ---------- */
    for (const tok of perRowTokenSet){
        if (!state.tokens.has(tok)){
        state.tokens.set(tok, {freq:0, impact:0, domains:new Set(), samples:[], rows:new Set(), urls:new Set()});
        }
        const rec = state.tokens.get(tok);
        rec.freq += 1;              // row presence (not shown in chip)
        rec.impact += imp;          // shown as “Imps.”
        rec.domains.add(domain || '(unknown)');
        uniqPush(rec.samples, primary, 10);
        rec.rows.add(idx);
    }

    state.rows.push({urls, domain, impact:imp});
    });

    // finalize included and available
    // auto-include from lexicon
    for (const [tok] of state.tokens){
    if (LEX.UNSAFE.has(tok)){
        state.includedSet.add(tok);
        state.autoIncluded.add(tok);
    }
    }
    state.includedOrder = Array.from(state.includedSet).sort((a,b)=>a.localeCompare(b));

    // build Available using URL threshold
    rebuildAvailable();
    updateStats();
    toggleEmptyState();

    }

function sortAndRenderAvailable(){
  const criterion = sortAvailable.value; // 'alpha' | 'freq' | 'impact'
  const list = Array.from(state.availableSet);
  list.sort((a,b)=>{
    if (criterion==='alpha') return byAlpha(a,b);
    if (criterion==='freq') return (state.tokens.get(b).freq - state.tokens.get(a).freq) || byAlpha(a,b);
    return (state.tokens.get(b).impact - state.tokens.get(a).impact) || byAlpha(a,b);
  });
  state.availableOrder = list;
  render();
}

/* ---------- Render ---------- */
function updateStats(){
  rowCount.textContent = String(state.rows.length);
  const domains = new Set(state.rows.map(r=>r.domain));
  domainCount.textContent = String(domains.size);
  tokenCount.textContent = String(state.tokens.size);
}
function chipHTML(tok, rec, kind){
  const auto = state.autoIncluded.has(tok);
  const urls = rec?.urls ? rec.urls.size : 0;
  const imps = rec?.impact ? (rec.impact|0) : 0;
  const cls = ['chip', kind==='included' && auto ? 'auto':'', kind==='available' && rec && rec._recent ? 'recent':''].filter(Boolean).join(' ');
  const btn = kind==='included' ? '×' : '+';
  const title = kind==='included' ? 'Remove' : 'Add';
  return `<span class="${cls}" data-token="${tok}" data-kind="${kind}">
    <b>${tok}</b>
    <small class="muted" title="URLs">URLs&nbsp;${urls}</small>
    <small class="muted" title="Impressions">Imps.&nbsp;${imps}</small>
    <button class="btn" aria-label="${title}" data-act="${kind==='included'?'remove':'add'}">${btn}</button>
  </span>`;
}



function render(){
  // included
  includedBox.innerHTML = state.includedOrder.map(t=>chipHTML(t, state.tokens.get(t), 'included')).join('');
  includedCount.textContent = String(state.includedOrder.length);

  // available
  const nodes = [];
  for (const t of state.availableOrder){
    const rec = state.tokens.get(t);
    nodes.push(chipHTML(t, rec, 'available'));
  }
  availableBox.innerHTML = nodes.join('');
  availableCount.textContent = String(state.availableOrder.length);
}

/* ---------- Interactions ---------- */
scanBtn.addEventListener('click', parseInput);
clearBtn.addEventListener('click', ()=>{
  fileInput.value = '';
  pasteInput.value = '';
  updateFileUI && updateFileUI();

  state.rows=[]; state.tokens.clear();
  state.includedSet.clear(); state.includedOrder.length=0;
  state.availableSet.clear(); state.availableOrder.length=0;
  state.autoIncluded.clear();

  rowCount.textContent='0'; domainCount.textContent='0'; tokenCount.textContent='0';
  included.innerHTML=''; available.innerHTML='';
  outputPanel.style.display='none';
  toggleEmptyState();
});

minUrls.addEventListener('change', rebuildAvailable);
sortAvailable.addEventListener('change', sortAndRenderAvailable);

sortAvailable.addEventListener('change', sortAndRenderAvailable);
impactCol.addEventListener('change', parseInput);
// Show all / Collapse without touching Included
let prevMinUrls = 2;
showAllAvail.addEventListener('click', ()=>{
  const mode = showAllAvail.getAttribute('data-mode') || 'all';
  if (mode === 'all'){
    prevMinUrls = Number(minUrls.value)||2;
    minUrls.value = 1;
    showAllAvail.textContent = 'Collapse';
    showAllAvail.setAttribute('data-mode','collapse');
  }else{
    minUrls.value = prevMinUrls ?? 2;
    showAllAvail.textContent = 'Show all';
    showAllAvail.setAttribute('data-mode','all');
  }
  rebuildAvailable();
});




addCustom.addEventListener('click', ()=>{
  const v = customKey.value.trim().toLowerCase();
  if (!v) return;
  const base = v.replace(/[^a-z\-]/g,'');
  if (!base) return;
  if (!state.includedSet.has(base)){
    state.includedSet.add(base);
    state.includedOrder.push(base);
    // remove from available if present
    if (state.availableSet.delete(base)){
      const i = state.availableOrder.indexOf(base);
      if (i>=0) state.availableOrder.splice(i,1);
    }
    render();
  }
  customKey.value = '';
});

includedBox.addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-act="remove"]');
  if (!btn) return;
  const chip = btn.closest('.chip');
  const tok = chip.getAttribute('data-token');
  // remove from included
  if (state.includedSet.delete(tok)){
    const i = state.includedOrder.indexOf(tok);
    if (i>=0) state.includedOrder.splice(i,1);
  }
  // add to available at end
  state.availableSet.add(tok);
  const rec = state.tokens.get(tok); rec._recent = true;
  state.availableOrder.push(tok);
  render();
});

availableBox.addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-act="add"]');
  if (!btn) return;
  const chip = btn.closest('.chip');
  const tok = chip.getAttribute('data-token');
  // add to included at end
  if (!state.includedSet.has(tok)){
    state.includedSet.add(tok);
    state.includedOrder.push(tok);
  }
  // remove from available
  if (state.availableSet.delete(tok)){
    const i = state.availableOrder.indexOf(tok);
    if (i>=0) state.availableOrder.splice(i,1);
  }
  render();
});

/* ---------- Hover details ---------- */
let stickyToken = null;
let stickyAnchor = null;

function positionHover(anchorEl){
  const rect = anchorEl.getBoundingClientRect();
  hoverBox.style.left = Math.min(window.innerWidth-560, rect.left) + 'px';
  hoverBox.style.top  = (window.scrollY + rect.bottom + 6) + 'px';
}

function showHover(token, anchorEl, makeSticky=false){
  const rec = state.tokens.get(token);
  if (!rec) return;

  const urlsCount = rec.urls ? rec.urls.size : 0;
  const imps = rec.impact|0;
  const paths = (rec.samples || []).map(u=>({ href:u, text:urlPath(u) }));

  hoverBox.innerHTML = `
    <div class="row" style="margin-bottom:6px">
      <b>${token}</b>
      <span class="pill small">URLs&nbsp;<b>${urlsCount}</b></span>
      <span class="pill small">Imps.&nbsp;<b>${imps}</b></span>
    </div>
    <div class="small muted">Sample paths</div>
    <div class="list">
      ${paths.map(p=>`<a href="${p.href}" target="_blank" rel="noopener">${p.text || p.href}</a>`).join('')}
    </div>
  `;

  positionHover(anchorEl);
  hoverBox.style.display = 'block';

  if (makeSticky){
    stickyToken = token;
    stickyAnchor = anchorEl;
    hoverBox.setAttribute('data-sticky','1');
  }else{
    hoverBox.removeAttribute('data-sticky');
  }
}

function hideHover(){
  if (stickyToken) return;
  hoverBox.style.display = 'none';
}

// hover preview when not sticky
document.addEventListener('mouseover', (e)=>{
  if (stickyToken) return;
  const chip = e.target.closest('.chip');
  if (chip && (chip.parentElement===includedBox || chip.parentElement===availableBox)){
    const t = chip.getAttribute('data-token');
    showHover(t, chip, false);
  }else{
    hideHover();
  }
});

// click anywhere on chip except +/× to toggle sticky
function chipToggleSticky(e){
  const chip = e.target.closest('.chip');
  if (!chip) return;
  if (e.target.closest('button[data-act]')) return; // let add/remove work
  const tok = chip.getAttribute('data-token');
  if (stickyToken === tok){
    stickyToken = null; stickyAnchor = null;
    hoverBox.style.display = 'none';
    hoverBox.removeAttribute('data-sticky');
  }else{
    stickyToken = tok;
    stickyAnchor = chip;
    showHover(tok, chip, true);
  }
}
includedBox.addEventListener('click', chipToggleSticky);
availableBox.addEventListener('click', chipToggleSticky);

// click outside to close sticky
document.addEventListener('click', (e)=>{
  if (!stickyToken) return;
  if (e.target.closest('#hoverBox') || e.target.closest('.chip')) return;
  stickyToken = null; stickyAnchor = null;
  hoverBox.style.display = 'none';
  hoverBox.removeAttribute('data-sticky');
});

// keep sticky positioned
window.addEventListener('scroll', ()=>{ if (stickyToken && stickyAnchor) positionHover(stickyAnchor); else hideHover(); });
window.addEventListener('resize', ()=>{ if (stickyToken && stickyAnchor) positionHover(stickyAnchor); else hideHover(); });

/* ---------- Create list + blocked articles ---------- */
createBtn.addEventListener('click', ()=>{
  const list = state.includedOrder.slice();
  csvOut.value = list.join(',');

  // Tally per-URL impact
  const urlImpact = new Map(); // url -> summed impact
  let totalImpact = 0;
  const blockedRows = new Set();

  for (let i=0;i<state.rows.length;i++){
    const row = state.rows[i];
    // does any included term appear in this row?
    let hits = false;
    for (const tok of list){
      const rec = state.tokens.get(tok);
      if (rec && rec.rows.has(i)){ hits = true; break; }
    }
    if (!hits) continue;

    blockedRows.add(i);
    const imp = Number(row.impact||0);
    totalImpact += imp;

    // use primary URL (first in row)
    const u = row.urls[0];
    urlImpact.set(u, (urlImpact.get(u)||0) + imp);
  }

  // Update metrics
  blockedUrlCount.textContent = String(urlImpact.size);
  blockedImpact.textContent = String(Math.round(totalImpact));

  // Render blocked list sorted by impact desc
  const sorted = Array.from(urlImpact.entries()).sort((a,b)=>b[1]-a[1]);
  blockedList.innerHTML = sorted.map(([u,imp])=>{
    const impTxt = isFinite(imp) ? Math.round(imp) : 0;
    return `<div class="row">
      <span class="pill small">Imps.&nbsp;<b>${impTxt}</b></span>
      <a href="${u}" target="_blank" rel="noopener">${u}</a>
    </div>`;
  }).join('') || '<div class="muted small">None</div>';

  // Show panel and scroll into view
  outputPanel.style.display = 'block';
  outputPanel.scrollIntoView({behavior:'smooth', block:'start'});
});


// Dropzone + file UI
function updateFileUI(){
  const f = fileInput.files && fileInput.files[0];
  if (!dzTitle) return;
  if (!f){ dzTitle.innerHTML = '<b>Browse or drop CSV/XLSX here</b>'; return; }
  const size = (f.size/1024/1024).toFixed(2)+' MB';
  dzTitle.innerHTML = `<b>${f.name}</b> <span class="muted small">(${size})</span>`;
}
if (browseBtn) browseBtn.addEventListener('click', (e)=>{ e.stopPropagation(); fileInput.click(); });
if (dropZone) dropZone.addEventListener('click', ()=> fileInput.click());
if (fileInput) fileInput.addEventListener('change', updateFileUI);

['dragenter','dragover'].forEach(ev=>{
  dropZone && dropZone.addEventListener(ev, e=>{
    e.preventDefault();
    e.dataTransfer.dropEffect='copy';
    dropZone.classList.add('dragover');
  });
});
['dragleave','drop'].forEach(ev=>{
  dropZone && dropZone.addEventListener(ev, e=>{
    e.preventDefault();
    dropZone.classList.remove('dragover');
  });
});
dropZone && dropZone.addEventListener('drop', e=>{
  const dt = e.dataTransfer;
  if (!dt) return;
  const f = [...(dt.files||[])][0];
  if (f) {
    // populate the hidden input so change events fire
    const dT = new DataTransfer();
    dT.items.add(f);
    fileInput.files = dT.files;
    updateFileUI();
  } else {
    const text = dt.getData('text') || dt.getData('text/plain');
    if (text) pasteInput.value = (pasteInput.value?pasteInput.value+'\n':'') + text.trim();
  }
});


    function resetAll(){
    // clear UI inputs
    const fileInputEl = document.getElementById('file');
    const pasteEl = document.getElementById('paste');
    if (fileInputEl) fileInputEl.value = '';
    if (pasteEl) pasteEl.value = '';

    // clear computed state
    state.rows = [];
    state.tokens.clear();
    state.includedSet.clear(); state.includedOrder.length=0;
    state.availableSet.clear(); state.availableOrder.length=0;
    state.autoIncluded.clear();

    // defaults for controls
    minUrls.value = 2;
    showAllAvail.textContent = 'Show all';
    showAllAvail.setAttribute('data-mode','all');
    updateAvailFilters?.();

    // counters and panels
    rowCount.textContent = '0';
    domainCount.textContent = '0';
    tokenCount.textContent = '0';
    included.innerHTML = '';
    available.innerHTML = '';
    outputPanel.style.display = 'none';

    updateFileUI && updateFileUI();
    toggleEmptyState();
    }

// run on initial load and BFCache restores
    window.addEventListener('DOMContentLoaded', resetAll);
    window.addEventListener('pageshow', (e)=>{ if (e.persisted) resetAll(); });

    document.addEventListener('DOMContentLoaded', ()=>{
    const backTop = document.getElementById('backTop');
    if (!backTop) return;

    const toggle = ()=>{
        if (window.scrollY > 400) backTop.classList.add('show');
        else backTop.classList.remove('show');
    };
    window.addEventListener('scroll', toggle, {passive:true});
    toggle(); // run once on load

    backTop.addEventListener('click', ()=> window.scrollTo({top:0, behavior:'smooth'}));
    });

    // button hover -> parent chip intent class
    includedBox.addEventListener('mouseover', e=>{
    const btn = e.target.closest('button[data-act]');
    const chip = e.target.closest('.chip');
    if (!chip) return;
    chip.classList.remove('will-add','will-remove');
    if (btn && btn.dataset.act==='remove') chip.classList.add('will-remove');
    });
    includedBox.addEventListener('mouseout', e=>{
    const chip = e.target.closest('.chip');
    if (chip) chip.classList.remove('will-add','will-remove');
    });
    availableBox.addEventListener('mouseover', e=>{
    const btn = e.target.closest('button[data-act]');
    const chip = e.target.closest('.chip');
    if (!chip) return;
    chip.classList.remove('will-add','will-remove');
    if (btn && btn.dataset.act==='add') chip.classList.add('will-add');
    });
    availableBox.addEventListener('mouseout', e=>{
    const chip = e.target.closest('.chip');
    if (chip) chip.classList.remove('will-add','will-remove');
    });


/* ---------- Ready ---------- */
</script>
<button id="backTop" aria-label="Back to top" title="Back to top">↑ Top</button>
</body>
</html>
