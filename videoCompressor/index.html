<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Smart Video Compressor</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
    }
    video {
      width: 100%;
      max-width: 640px;
      margin: 10px 0;
    }
    .label {
      font-weight: bold;
      margin-top: 20px;
    }
    #outputSection {
      display: none;
    }
    #downloadLink {
      display: none;
      margin-top: 10px;
      display: inline-block;
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
    }
  </style>
</head>
<body>
  <h1>Smart Video Compressor (Under 3MB)</h1>

  <input type="file" id="uploader" accept="video/*" />
  
  <div id="inputSection">
    <p class="label">Original Video Preview:</p>
    <video id="preview" controls></video>
  </div>

  <button id="compressBtn" disabled>Compress to under 3MB</button>

  <div id="outputSection">
    <p class="label">Compressed Video:</p>
    <video id="outputVideo" controls></video>
    <br />
    <a id="downloadLink" download="compressed.mp4">⬇️ Download Compressed Video</a>
  </div>

  <script type="module">
    import { createFFmpeg } from 'https://unpkg.com/@ffmpeg/ffmpeg@0.12.4/dist/esm/index.js';
    import { fetchFile } from 'https://unpkg.com/@ffmpeg/util@0.12.4/dist/esm/index.js';


    const ffmpeg = createFFmpeg({ log: true });
    let videoDuration = 0;
    let selectedFile = null;

    const uploader = document.getElementById('uploader');
    const preview = document.getElementById('preview');
    const compressBtn = document.getElementById('compressBtn');
    const outputSection = document.getElementById('outputSection');
    const outputVideo = document.getElementById('outputVideo');
    const downloadLink = document.getElementById('downloadLink');

    uploader.addEventListener('change', (e) => {
      selectedFile = e.target.files[0];
      if (!selectedFile) return;

      const url = URL.createObjectURL(selectedFile);
      preview.src = URL.createObjectURL(selectedFile);
        preview.load();     

      preview.onloadedmetadata = () => {
        videoDuration = preview.duration;
        compressBtn.disabled = false;
      };
    });

    compressBtn.addEventListener('click', async () => {
      if (!selectedFile || !videoDuration) return;

      compressBtn.innerText = 'Compressing...';
      compressBtn.disabled = true;

      if (!ffmpeg.isLoaded()) await ffmpeg.load();

      ffmpeg.FS('writeFile', 'input.mp4', await fetchFile(selectedFile));

      // Estimate bitrate to target 3MB
      const targetSizeKB = 3000;
      const estimatedBitrate = Math.floor((targetSizeKB * 8) / videoDuration); // kbps

      await ffmpeg.run(
        '-i', 'input.mp4',
        '-vf', 'scale=-2:480,fps=24',
        '-b:v', estimatedBitrate + 'k',
        '-c:a', 'aac',
        '-b:a', '64k',
        'output.mp4'
      );

      const data = ffmpeg.FS('readFile', 'output.mp4');
      const blob = new Blob([data.buffer], { type: 'video/mp4' });
      const url = URL.createObjectURL(blob);

      outputVideo.src = url;
      downloadLink.href = url;
      outputSection.style.display = 'block';
      downloadLink.style.display = 'inline';

      compressBtn.innerText = 'Compress to under 3MB';
      compressBtn.disabled = false;
    });
  </script>
</body>
</html>
