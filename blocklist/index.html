<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>BlockList</title>
<link rel="icon" href="data:,">
<style>
  /* =========================
     Vars + Theme
     ========================= */
  :root{
    --wrap: 1400px;
    --bg:#0f1115;
    --panel:#151922;
    --text:#e6e6e6;
    --muted:#a8b0bf;
    --chip:#232a36;
    --chip-text:#e6e6e6;
    --chip-muted:#9aa4b6;
    --accent:#5aa3ff;
    --ok:#2fb170;
    --warn:#f5c451;
    --danger:#e35d6a;
    --border:#2b3442;
    --link:#75b4ff;
    --shadow:0 5px 20px rgba(0,0,0,.4);
    --content-pad:14px;
    --hdr-h:40px;
    --bar-h:56px; /* runtime-corrected via JS */
    --vr:16px;
    --accent:#8b5cf6;
    --accent2:#22d3ee;
  }
  [data-theme="light"]{
    --bg:#fafafa; --panel:#ffffff; --text:#0e1420; --muted:#465064; --chip:#f1f3f7;
    --chip-text:#0e1420; --chip-muted:#5c667a; --accent:#1d6fff; --ok:#0a9157; --warn:#c18b14;
    --danger:#c53b49; --border:#d8deea; --link:#0a66d9; --shadow:0 6px 18px rgba(0,0,0,.08)--accent:#8b5cf6;
    --accent2:#22d3ee;
  }
  
  /* =========================
     Base + One horizontal scrollbar
     ========================= */
  html, body { height:100%; scrollbar-gutter: stable both-edges; }
  html { min-width:980px; overflow-x:auto; }
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    display:flex; flex-direction:column;
    padding-top:var(--bar-h);
    overflow-x:visible; /* prevent nested scrollbars */
  }
  @supports not (scrollbar-gutter: stable) { html { overflow-y:scroll; } }
  
  /* =========================
     App bar + Footer
     ========================= */
  .appbar{
    position:fixed; top:0; left:0; right:0; z-index:1000;
    background:var(--panel); border-bottom:1px solid var(--border); box-shadow:var(--shadow);
  }
  .appbar .bar, .footer .bar{
    max-width:var(--wrap); margin:0 auto; padding:10px 16px;
    display:flex; gap:16px; align-items:center;
  }
  .title{font-weight:700; letter-spacing:.2px}
  .spacer{flex:1}
  .toggle{display:inline-flex; gap:8px; align-items:center}
  .footer{ border-top:1px solid var(--border); }
  .footer .bar{
    padding:12px 16px; justify-content:space-between; color:var(--muted); font-size:12px;
  }
  .footer .link{ color:var(--link); text-decoration:none; }
  .footer .link:hover{ text-decoration:underline; }
  
  /* =========================
     Layout
     ========================= */
  .page{ flex:1; display:block; }
  .container{ max-width:var(--wrap); margin:18px auto; padding:0 16px 40px; }
  .grid{
    display:grid;
    grid-template-columns:340px minmax(620px,1fr); /* 340 + 20 gap + 620 = 980 */
    column-gap:20px;
    min-width:0; /* no inner horizontal scrollbars */
  }
  
  /* =========================
     Panels
     ========================= */
  .panel{
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:10px;
    box-shadow:var(--shadow);
  }
  .panel h3{
    margin:0; padding:16px 14px; border-bottom:1px solid var(--border); font-size:15px;
  }
  .panel h3 + .content{ padding-top:var(--vr) }
  .content{ padding:16px var(--content-pad) }
  
  /* Sidebar: sticky, no horizontal scroll */
  .panel.sidebar{
    position:sticky; top:calc(var(--bar-h) + 10px); align-self:start;
    width:340px; flex:0 0 340px; min-width:340px;
    overflow:auto; overflow-x:hidden; overscroll-behavior:contain;
    -ms-overflow-style:none; scrollbar-width:none; scrollbar-gutter:auto;
  }
  .panel.sidebar::-webkit-scrollbar{ width:0; height:0; }
  
  /* Results panel min width */
  .panel.results{ min-width:620px; overflow-x:visible; }
  
  /* =========================
     Controls, text, form elements
     ========================= */
  label{font-size:13px; color:var(--muted)}
  input[type=file]{display:block; margin-top:8px}
  textarea{
    width:100%; height:90px; max-width:100%;
    border:1px solid var(--border); background:var(--bg); color:var(--text);
    border-radius:8px; padding:8px; resize:vertical; box-sizing:border-box;
  }
  select, input[type=number], input[type=text]{
    border:1px solid var(--border); background:var(--bg); color:var(--text);
    border-radius:8px; padding:6px 8px; box-sizing:border-box; max-width:100%;
  }
  .panel.sidebar input[type="number"]#minUrls{ width:110px; }
  .panel.sidebar select#sortIncluded,
  .panel.sidebar select#sortAvailable{ max-width:220px; }
  .panel.sidebar select#impactCol{ max-width:260px; }
  
  .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  
  /* Buttons */
  .btn{
    border:1px solid var(--border); background:var(--chip); color:var(--text);
    padding:8px 12px; border-radius:8px; cursor:pointer; flex:0 0 auto;
  }
  .btn.primary{ background:var(--accent); border-color:transparent; color:#fff }
  .btn.ghost{ background:transparent }
  .btn[disabled]{ opacity:.55; cursor:not-allowed }
  
  /* Toolbar stays one line */
  .toolbar{
    display:flex; align-items:center; gap:8px; flex-wrap:nowrap; min-width:0; margin-top:10px;
  }
  .pill{
    display:inline-flex; gap:6px; align-items:center;
    border:1px solid var(--border); padding:6px 10px; border-radius:999px;
    background:var(--chip); color:var(--chip-text); white-space:nowrap;
  }
  .hint{ color:var(--muted); font-size:12px }
  .small{ font-size:12px }
  .mono{ font-family:ui-monospace,SFMono-Regular,Consolas,Menlo,monospace }
  .muted{ color:var(--muted) }
  .float-right{ margin-left:auto }
  .danger{ color:var(--danger) }
  .ok{ color:var(--ok) }
  .warn{ color:var(--warn) }
  #availFilters{ color:var(--muted) }
  
  /* Two-column control groups fit */
  .two{
    display:grid;
    grid-template-columns:minmax(0,1fr) minmax(0,1fr);
    gap:var(--vr);
  }
  .stack{ display:grid; grid-template-columns:1fr; gap:var(--vr) }
  
  /* =========================
     Chips
     ========================= */
  .chips{ display:flex; flex-wrap:wrap; gap:8px; min-width:0; }
  .chip{
    display:inline-flex; align-items:center; gap:8px;
    background:var(--chip); border:1px solid var(--border); color:var(--chip-text);
    padding:6px 10px; border-radius:999px; cursor:pointer; flex:0 0 auto;
  }
  .chip small{ color:var(--chip-muted); font-size:11px }
  .chip .btn{ border:0; background:transparent; color:var(--muted); font-weight:700; cursor:pointer }
  .chip .btn:hover{ color:var(--text) }
  .chip.auto{ border-style:solid }
  .chip.recent{ outline:1px dashed var(--warn) }
  /* +/- hover intent */
  .chip.will-add{
    background:color-mix(in oklab, var(--ok) 22%, transparent);
    border-color:var(--ok);
  }
  .chip.will-remove{
    background:color-mix(in oklab, var(--danger) 22%, transparent);
    border-color:var(--danger);
  }
  .chip.will-add b, .chip.will-add small,
  .chip.will-remove b, .chip.will-remove small{ color:inherit }
  
  /* =========================
     Sticky section headers
     ========================= */
  .section-header{
    display:flex; align-items:center; gap:8px; margin-bottom:0;
  }
  .section-header .row{
    margin-left:auto; display:flex; align-items:center; gap:8px; white-space:nowrap; flex:0 0 auto;
  }
  .section-header.sticky{
    position:sticky; top:var(--bar-h); z-index:7;
    background:var(--bg);
    margin-left:calc(var(--content-pad) * -1);
    margin-right:calc(var(--content-pad) * -1);
    padding:10px var(--content-pad);
    min-height:40px; border-bottom:1px solid var(--border);
  }
  .section-header.sticky b{ margin:0; line-height:1 }
  .section-header.sticky .hint{ margin:0 0 0 8px }
  .section-header.sticky + #included,
  .section-header.sticky + #available{ margin-top:var(--vr) }
  #included{ margin-top:8px }
  .sticky-scope{ min-width:0; }
  
  /* =========================
     Dropzone
     ========================= */
  .dropzone{
    position:relative; border:2px dashed var(--border); border-radius:12px;
    padding:18px; text-align:center; background:var(--bg);
    transition:.15s border-color,.15s background; box-sizing:border-box; width:100%;
  }
  .dropzone.dragover{ border-color:var(--accent); background:color-mix(in oklab, var(--accent) 12%, transparent) }
  #dropZone{ position:relative }
  #dropZone input[type="file"]{ display:none !important }
  #dropZone .dz-input{ position:absolute; inset:0; width:100%; height:100%; opacity:0; cursor:pointer; }
  .dz-inner{ display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap }
  .dz-title{ font-weight:600; text-align:center }
  .sidebar .dropzone, .sidebar textarea#paste{ width:100%; max-width:100%; }
  .sidebar textarea#paste{ resize:vertical; box-sizing:border-box }
  .sidebar .dropzone .dz-title{ overflow-wrap:anywhere; word-break:break-word }
  .sidebar .dropzone, .sidebar .dropzone * { box-sizing:border-box }
  
  /* space helpers for dropzone */
  .sidebar label + .dropzone{ margin-top:10px; }
  .sidebar .dropzone, .sidebar #fileNameRow.filechip{ margin-bottom:12px; }
  
  /* =========================
     File chip (selected file)
     ========================= */
  .filechip{
    display:flex; align-items:center; gap:8px;
    width:100%; max-width:100%; min-width:0;
    padding:8px 10px; border:1px solid var(--border); border-radius:10px;
    background:var(--bg); margin-top:6px; overflow:hidden;
  }
  .filechip .name{
    flex:1 1 auto; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  }
  .filechip .size{ flex:0 0 auto }
  .filechip .btn{ flex:0 0 auto; margin-left:8px }
  
  /* =========================
     Hover popover
     ========================= */
  .popover{
    position:absolute; z-index:50; min-width:360px; max-width:520px;
    background:var(--panel); border:1px solid var(--border);
    border-radius:10px; box-shadow:var(--shadow); padding:10px 10px
  }
  .list{ max-height:220px; overflow:auto; margin:4px 0 0; padding:0 }
  .list a{
    display:block; padding:6px 8px; color:var(--link); text-decoration:none;
    white-space:nowrap; overflow:hidden; text-overflow:ellipsis
  }
  .list a:hover{ text-decoration:underline }
  html[data-theme="dark"] #blockedList a{ color:#e6f8f2; text-decoration:none }
  
  /* =========================
     Output panel + blocked list
     ========================= */
  #outputPanel{ margin:14px 0; }
  #outputPanel .two{ display:grid; grid-template-columns:2fr 1fr; gap:12px }
  #outputTopRow{
    display:grid; grid-template-columns:minmax(0,2fr) minmax(260px,1fr);
    gap:12px; align-items:start;
  }
  #outputTopRow > div:last-child{ padding-top:24px }
  #outputTopRow label{ display:block; margin-bottom:6px }
  #outputPanel textarea#csvOut{ width:100%; min-height:180px }
  #outputTopRow > div:nth-child(2){ margin:7px 22px } /* custom tweak */
  
  #blockedDetails{ margin-top:18px }
  #blockedList .row{
    display:grid; grid-template-columns:110px 1fr; gap:8px;
    align-items:start; margin:4px 0;
  }
  #blockedList .row .pill.small{ justify-self:start; text-align:center }
  #blockedList .row a{ display:block; word-break:break-word; overflow-wrap:anywhere; line-height:1.25 }
  #blockedList .pill.small{ min-width:84px; text-align:center }
  
  /* =========================
     Back to top
     ========================= */
  #backTop{
    position:fixed; right:16px; bottom:16px;
    padding:8px 12px; border-radius:999px;
    border:1px solid var(--border);
    background:var(--panel); color:var(--text);
    box-shadow:0 2px 8px rgb(0 0 0 / 12%);
    cursor:pointer; opacity:0; pointer-events:none; transition:opacity .15s ease;
  }
  #backTop.show{ opacity:1; pointer-events:auto }
  
  /* =========================
     Safety: force overlay if under 980px (even if JS fails)
     ========================= */
  @media (max-width:980px){
    #viewportOverlay{ display:flex !important; }
  }
  
  /* =========================
     Compact tweaks near 1100px
     ========================= */
  @media (max-width:1100px){
    .toolbar .pill{ font-size:12px; padding:2px 6px; }
    .toolbar .btn{ padding:4px 8px; }
  }

    /* --- Sidebar width guard: nothing may grow wider than 340px --- */
.panel.sidebar,
.panel.sidebar .content,
.panel.sidebar .stack,
.panel.sidebar .two,
.panel.sidebar .row { max-width: 100%; min-width: 0; overflow-x: hidden; }

/* --- File chip: grid with hard columns so long names truncate --- */
.filechip{
  display: grid;                 /* switch from flex -> grid */
  grid-template-columns: 1fr auto auto; /* name | size | button */
  align-items: center;
  gap: 8px;
  width: 100%;
  max-width: 100%;
  box-sizing: border-box;
  overflow: hidden;
}
.filechip .name{
  min-width: 0;                  /* allow shrink */
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}
.filechip .size{ white-space: nowrap; }
.filechip .btn{ justify-self: end; }

/* --- Dropzone + paste: never exceed sidebar --- */
.sidebar .dropzone{ width:100%; max-width:100%; box-sizing:border-box; }
.sidebar textarea#paste{
  display:block;
  width:100%;
  max-width:100%;
  box-sizing:border-box;
}

/* --- Controls: no horizontal growth on focus/content --- */
.panel.sidebar input[type="number"],
.panel.sidebar input[type="text"],
.panel.sidebar select,
.panel.sidebar textarea{
  max-width:100%;
  min-width:0;
  box-sizing:border-box;
}

/* --- Sidebar toolbars may wrap; no width push --- */
.panel.sidebar .toolbar{ flex-wrap: wrap; min-width: 0; }

/* Keep ONLY the Scan/Rows/Domains/Terms toolbar on one line */
.panel.sidebar .toolbar:has(#scanBtn){
  flex-wrap: nowrap;       /* no wrap for this toolbar */
  gap: 6px;
  overflow: hidden;        /* never widen the sidebar */
  min-width: 0;
}

/* Compact its controls so all four fit */
.panel.sidebar .toolbar:has(#scanBtn) .btn{
  padding: 6px 10px;
  flex: 0 0 auto;
}
.panel.sidebar .toolbar:has(#scanBtn) .pill{
  padding: 4px 8px;
  font-size: 11px;
  flex: 0 1 auto;          /* allow slight shrink */
  min-width: 0;
  white-space: nowrap;
}
.panel.sidebar .toolbar:has(#scanBtn) .pill .muted{ font-size: 11px; }

/* Click-to-copy box */
.copybox{
  position: relative;
  border:1px solid var(--border);
  border-radius:8px;
  cursor: copy;
}
.copybox textarea{
  pointer-events: none;       /* block typing/selection */
  background: var(--bg);
  color: var(--text);
  border:0;                   /* border handled by .copybox */
  width:100%; min-height:180px;
  padding:8px; resize: none;  /* no manual resize */
  outline: none;
}
.copybox::after{
  content:"Click to copy";
  position:absolute; inset:0;
  display:flex; align-items:center; justify-content:center;
  background:color-mix(in oklab, var(--panel) 65%, transparent);
  color:var(--muted);
  font-weight:600; letter-spacing:.2px;
  opacity:0; transition:opacity .12s ease-in-out;
  border-radius:8px;
}
.copybox:hover::after{ opacity:1; }
.copybox.copied::after{ content:"Copied"; opacity:1; }

/* Small tweak so our label doesn’t look disabled next to overlay */
#outputTopRow label + .copybox{ margin-top:6px; }

/* “i” info badge + tooltip */
.icon-btn.info{
  display:inline-flex; align-items:center; justify-content:center;
  width:26px; height:26px; border-radius:50%;
  border:1px solid var(--border); background:var(--chip); color:var(--text);
  font-weight:700; line-height:1; cursor:help;
}
.icon-btn.info:hover{ filter:brightness(1.05); }

/* Pure-css tooltip from data-tip */
.icon-btn.info[data-tip]{
  position:relative;
}
.icon-btn.info[data-tip]::after{
  content:attr(data-tip);
  position:absolute; right:0; top:calc(100% + 10px);
  width:min(520px, 70vw);
  background:var(--panel); color:var(--text);
  border:1px solid var(--border); border-radius:10px; box-shadow:var(--shadow);
  padding:10px 12px; font-size:12px; line-height:1.35;
  opacity:0; pointer-events:none; transform:translateY(-4px);
  transition:opacity .12s, transform .12s;
  z-index:1001; text-align:left;
}
.icon-btn.info[data-tip]::before{
  content:""; position:absolute; right:8px; top:100%;
  border:6px solid transparent; border-top-color:var(--border);
  transform:translateY(-1px);
  opacity:0; transition:opacity .12s;
}
.icon-btn.info:hover::after,
.icon-btn.info:hover::before{
  opacity:1; transform:translateY(0);
}

/* Clickable hint with higher contrast, no UA purple outline */
:root{ --chip-hover:#9ad1ff; } /* fixed light blue for chips */

.chip{ transition: background-color .12s ease, box-shadow .12s ease; }
.chip:focus, .chip:focus-visible{ outline:0; } /* remove purple outline */

.chip.hover-soft{
  background: color-mix(in oklab, var(--chip-hover) 38%, transparent);
  box-shadow: inset 0 0 0 1.5px color-mix(in oklab, var(--chip-hover) 70%, transparent);
}
.chip.chip-active{
  background: color-mix(in oklab, var(--chip-hover) 54%, transparent);
  box-shadow: inset 0 0 0 2px color-mix(in oklab, var(--chip-hover) 88%, transparent);
}

/* Intent states override the blue hint */
.chip.will-add{    background: color-mix(in oklab, var(--ok)     30%, transparent); box-shadow:none; }
.chip.will-remove{ background: color-mix(in oklab, var(--danger) 30%, transparent); box-shadow:none; }

/* Slight readability boost on dark theme only */
html[data-theme="dark"] .chip.hover-soft,
html[data-theme="dark"] .chip.chip-active{ text-shadow: 0 1px 0 rgba(0,0,0,.35); }

/* Keep Scan blue, independent of global accents */
#scanBtn.btn.primary{
  background:#5aa3ff; border:0; color:#fff;
  box-shadow:0 4px 12px rgba(0,0,0,.18);
}
#scanBtn.btn.primary:hover{ filter:saturate(1.05) brightness(1.03); }
#scanBtn.btn.primary:focus-visible{
  outline:2px solid color-mix(in oklab, #5aa3ff 60%, transparent);
  outline-offset:2px;
}

#scanBtn.btn.primary{ box-shadow:none !important; }


#blockedDetails > summary{ cursor:pointer !important; }

input[type="text"],
input[type="number"],
textarea,
select{ outline:none; }
input[type="text"]:focus,
input[type="number"]:focus,
textarea:focus,
select:focus,
input[type="text"]:focus-visible,
input[type="number"]:focus-visible,
textarea:focus-visible,
select:focus-visible{
  outline:none !important;
  box-shadow:none !important;
  border-color:var(--border) !important;
}
/* Dropzone and paste area containers: no focus glow */
.dropzone:focus,
.dropzone:focus-within{ outline:none !important; box-shadow:none !important; border-color:var(--border) !important; }

/* 3) Restore “Generate List” gradient with higher specificity */
#createBtn.btn.primary{
  background-image:linear-gradient(135deg,var(--accent),var(--accent2)) !important;
  background-color:transparent !important; /* defeat any .btn background */
  border:0 !important;
  color:#fff !important;
  box-shadow:0 6px 18px rgba(0,0,0,.18);
}
#createBtn.btn.primary:hover{ filter:saturate(1.1) brightness(1.04); }
#createBtn.btn.primary:focus-visible{ outline:0; }

/* Add All: sharper in light mode, keeps red hint in dark */
#addAllAvail{
  border:1px solid color-mix(in oklab, var(--danger) 55%, transparent);
  color: color-mix(in oklab, var(--danger) 78%, black);
  background: color-mix(in oklab, var(--danger) 10%, transparent);
}
#addAllAvail:hover{
  background: color-mix(in oklab, var(--danger) 18%, transparent);
}
[data-theme="light"] #addAllAvail{
  background:#fff;
  color:#b0182a;
  border-color:#e16a78;
  box-shadow:0 1px 0 rgba(0,0,0,.04), 0 6px 14px rgba(0,0,0,.06);
}
[data-theme="light"] #addAllAvail:hover{
  background:#ffeef0; /* light pink tint */
  border-color:#d94b5e;
}
#addAllAvail:focus-visible{
  outline:2px solid color-mix(in oklab, var(--danger) 45%, transparent);
  outline-offset:2px;
}

/* Chip text turns pure white ONLY in dark mode */
html[data-theme="dark"] .chip.chip-active,
html[data-theme="dark"] .chip.chip-active b,
html[data-theme="dark"] .chip.chip-active small,
html[data-theme="dark"] .chip.chip-active .btn{
  color:#fff !important;
  text-shadow:0 1px 0 rgba(0,0,0,.25);
}

[data-theme="dark"] .blocklist-logo{ content:url('images/blocklist-logo-white.png') }

/* Light mode keeps normal text color */
html[data-theme="light"] .chip.chip-active,
html[data-theme="light"] .chip.chip-active b,
html[data-theme="light"] .chip.chip-active small,
html[data-theme="light"] .chip.chip-active .btn{
  color:inherit !important;
  text-shadow:none;
}

.blocklist-logo {
  max-height:32px;
  width:auto;
  border-radius:6px;
}

/* Available search box */
#availSearch{
  height:28px;
  padding:4px 8px;
  border:1px solid var(--border);
  border-radius:8px;
  background:var(--bg);
  color:var(--text);
  box-sizing:border-box;
  width:180px;
}
#availSearch::placeholder{ color:var(--muted); }
@media (max-width:1100px){ #availSearch{ width:150px; } }

/* === Chips spacing without sticky jump or seams === */
:root { --chip-gap: 12px; }

/* space inside chip areas */
#included { padding-bottom: var(--chip-gap); }
#available{ padding-bottom: var(--chip-gap); }

/* Sticky headers: keep borders visible when stacked */
.panel.results .section-header.sticky{
  background: var(--panel);
  box-shadow: none;             /* replace earlier inset border */
}

/* Blocked (Included) bar stays above and draws its bottom line on top */
.hdr-included{ z-index: 8; }    /* higher than Available (7) */
.hdr-included::after{
  content:"";
  position:absolute; left:0; right:0; bottom:-1px;
  height:1px; background: var(--border);
}

/* Available bar stays below; keep the negative pull-up */
.hdr-available{
  z-index: 7;
  margin-top: calc(-1 * var(--chip-gap));  /* keep previous pull-up */
}

div.section-header:nth-child(3){
  margin-top:1px;
}

/* “Run demo” looks like text, but clickable */
.action-link{
  appearance:none; border:0; background:transparent; padding:0;
  font-size:13px; color:var(--link); cursor:pointer;
}
.action-link:hover{ text-decoration:underline; }

/* Label row with right-justified "run demo" */
.label-row{ display:flex; align-items:center; min-width:0; margin-bottom:10px;}
.label-row .action-link{ margin-left:auto; font-size:13px; }

.panel.sidebar .label-row .action-link{ color:var(--link); }


  </style>
  
</head>
<body>
    <header class="appbar">
      <div class="bar">
          <img class="blocklist-logo" src="/images/logos/blocklist-logo.PNG">
        <div class="spacer"></div>
        <button id="infoBtn" class="icon-btn info" type="button"
        aria-label="About this tool"
        data-tip="Upload a CSV/XLSX with at least one URL column and, optionally, an impressions/impact column. The tool extracts risky terms from URL paths, auto-includes known unsafe terms, and shows deduped blocked/available impact by URL. Choose a numeric impact column or let Auto pick. You can also paste URLs. Click Generate List to produce the comma-separated block list.">
          i
        </button>
        <label class="toggle">
          <input id="themeToggle" type="checkbox" />
          <span class="hint">Light mode</span>
        </label>
      </div>
    </header>
<main class="page">
<div class="container">
    <div class="grid">
        <!-- LEFT: sticky sidebar -->
        <div class="panel sidebar">
          <h3>1) Input</h3>
          <div class="content">
            <div class="stack">
              <div>
                <div class="row label-row">
                  <label>Upload CSV/XLSX</label>
                  <button id="runDemo" class="action-link" type="button">run demo</button>
                </div>                              
                <div id="dropZone" class="dropzone" tabindex="0" role="button" aria-label="Browse or drop a file">
                    <input id="file" class="dz-input" type="file" accept=".csv,.xlsx,.xls">
                    <div class="dz-inner">
                      <div class="dz-title"><b>Browse or drop CSV/XLSX here</b></div>
                      <button id="browseBtn" class="btn">Browse</button>
                    </div>
                  </div>
                  <div id="fileNameRow" class="filechip" style="display:none"></div>                           
                <div class="hint small">No upload. Processing happens in your browser.</div>
              </div>
      
              <div>
                <label>Or paste URLs / CSV rows</label>
                <textarea id="paste" placeholder="Paste URLs or a CSV snippet…"></textarea>
              </div>
            </div>
      
            <div class="toolbar">
              <button id="scanBtn" class="btn primary">Scan</button>
              <div class="pill"><span class="muted small">Rows:</span> <b id="rowCount">0</b></div>
              <div class="pill"><span class="muted small">Domains:</span> <b id="domainCount">0</b></div>
              <div class="pill"><span class="muted small">Terms:</span> <b id="tokenCount">0</b></div>
            </div>
          </div>
      
          <h3>2) Settings</h3>
          <div class="content">
            <div class="two" style="margin-top:0">
                <div>
                  <label>Minimum URLs per term</label>
                  <input id="minUrls" type="number" min="1" value="2" />
                  <div class="hint small">Set to 1 to see all.</div>
                </div>
                <div>
                  <label>Sort “Blocked” by</label>
                  <select id="sortIncluded">
                    <option value="impact">Impact</option>
                    <option value="alpha" selected>Alphabetical</option>
                    <option value="freq">Frequency</option>
                  </select>
              
                  <div style="height:10px"></div>
              
                  <label>Sort “Available” by</label>
                  <select id="sortAvailable">
                    <option value="alpha">Alphabetical</option>
                    <option value="freq">Frequency</option>
                    <option value="impact" selected>Impact</option>
                  </select>
                </div>
              </div>              
      
            <div class="two" style="margin-top:10px">
              <div>
                <label>Impact column (optional)</label>
                <select id="impactCol"><option value="">Auto-detect…</option></select>
                <div class="hint small">Looks for numeric columns like “impressions, failed, blocked, views, qty”.</div>
              </div>
              <div>
                <label>Add custom keyword</label>
                <div class="row">
                  <input id="customKey" type="text" placeholder="e.g., los-angeles" />
                  <button id="addCustom" class="btn">Add</button>
                </div>
              </div>
            </div>
      
            <div class="toolbar" style="margin-top:14px; justify-content:flex-start">
                <button id="createBtn" class="btn primary">Generate List</button>
              </div>              
          </div>
        </div>
      
        <!-- RIGHT: results column -->
        <div class="panel results" id="resultsPanel">
          <h3>3) Results</h3>
          <div class="content">
            <p id="emptyState" class="hint empty-inline">
                Upload a CSV/XLSX or paste URLs to start building your custom term list.
              </p>          
              <div class="sticky-scope">
                <div class="section-header sticky hdr-included">
                  <b>Blocked (<span id="includedCount">0</span>)</b>
                  <span id="includedSortLabel" class="hint small">Alphabetical ↓</span>
                  <span id="includedImpactTotal" class="hint small" style="margin-left:auto">Impact: 0</span>
                </div>
                <div id="included" class="chips" aria-live="polite"></div>
              </div>              
              
              <div class="section-header sticky hdr-available">
                <b>Available (<span id="availableCount">0</span>)</b>
                <span id="availFilters" class="hint small"></span>
                <span id="availSort" class="hint small"></span>
                <div class="row" style="margin-left:auto;align-items:center;gap:8px">
                  <input id="availSearch" type="search" placeholder="Search terms…" hidden>
                  <button id="showAllAvail" class="btn ghost small">Show all</button>
                  <button id="addAllAvail" class="btn small">Add All</button>
                  <span id="availableImpactTotal" class="hint small">Impact: 0</span>
                </div>
              </div>                                 
                            
            <div id="available" class="chips" aria-live="polite"></div>
      
            <div id="outputPanel" class="panel" style="margin-top:14px;display:none">
                <h3>Output</h3>
                <div class="content">
                  <div class="two" id="outputTopRow">
                    <div>
                      <label>Comma-separated</label>
                      <div class="copybox" id="csvOutBox" role="button" aria-label="Click to copy">
                        <textarea id="csvOut" class="mono" readonly aria-readonly="true" tabindex="-1"></textarea>
                      </div>
                    </div>
                    <div>
                        <label>Metrics</label>
                        <div class="kv" style="margin-top:6px">
                          <div class="muted">Unique URLs blocked:</div><div id="blockedUrlCount">0</div>
                          <div class="muted" id="blockedImpactLabel">Total impact blocked:</div><div id="blockedImpact">0</div>
                        </div>
                      </div>              
                  </div>
              
                  <details id="blockedDetails" style="margin-top:10px">
                    <summary>Show blocked articles</summary>
                    <div id="blockedList"></div>
                  </details>
                </div>
            </div>                         
            <div id="hoverBox" class="popover" style="display:none"></div>
          </div>
        </div>
      </div>      
</div>
</main>

<script>
/* ---------- Theme ---------- */
const themeToggle = document.getElementById('themeToggle');
(function initTheme(){
  const saved = localStorage.getItem('uts-theme');
  const prefersLight = window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
  const isLight = saved ? saved==='light' : prefersLight;
  document.documentElement.setAttribute('data-theme', isLight ? 'light' : 'dark');
  themeToggle.checked = isLight;
})();
themeToggle.addEventListener('change', ()=>{
  const mode = themeToggle.checked ? 'light' : 'dark';
  document.documentElement.setAttribute('data-theme', mode);
  localStorage.setItem('uts-theme', mode);
});

async function ensureXLSX(){
  if (window.XLSX) return true;
  const candidates = [
    './lib/xlsx.full.min.js',                                   // local vendored copy
    'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.2/xlsx.full.min.js',
    'https://unpkg.com/xlsx@0.20.2/dist/xlsx.full.min.js'
  ];
  for (const url of candidates){
    try{
      await new Promise((res,rej)=>{
        const s=document.createElement('script');
        s.src=url; s.async=true; s.onload=res; s.onerror=()=>rej();
        document.head.appendChild(s);
      });
      if (window.XLSX) return true;
    }catch{}
  }
  return false; // CSV-only fallback
}


function toggleEmptyState(){
  const hasData = state.rows.length>0;
  const empty = document.getElementById('emptyState');
  if (empty) empty.style.display = hasData ? 'none' : 'block';

  // hide lists and output when empty, keep sticky headers visible
  document.getElementById('included').style.display  = hasData ? '' : 'none';
  document.getElementById('available').style.display = hasData ? '' : 'none';
  document.getElementById('outputPanel').style.display = hasData ? document.getElementById('outputPanel').style.display : 'none';
}


/* ---------- Lexicon load (with fallback) ---------- */
let LEX = null;
const FALLBACK_UNSAFE = {
  disasters:[
    "wildfire","fire","earthquake","hurricane","tornado","flood","evacuation",
    "smoke","eruption","tsunami","landslide","avalanche","blizzard","outage",
    "blackout","collapse","explosion","derailment","crash","collision","spill","leak"
  ],
  crime_violence:[
    "shooting","stabbing","homicide","murder","assault","kidnapping","arson",
    "riot","terrorism","bomb","hostage","threat"
  ],
  legal:[
    "subpoena","indictment","arrest","charges","lawsuit","litigation","conviction",
    "trial","sentencing","appeal","fraud","bribery","corruption","money-laundering",
    "racketeering","rico","misconduct","impeachment"
  ],
  health_safety:[
    "outbreak","pandemic","quarantine","contamination","recall","poisoning",
    "toxin","radiation","hazmat","biohazard","overdose","opioid","fentanyl"
  ],
  finance_instability:[
    "bankruptcy","insolvency","default","foreclosure","eviction","layoff","strike","boycott"
  ],
  politics_risk:[
    "coup","insurrection","sedition","treason","crackdown","curfew","martial-law",
    "ban","banned","protest","unrest"
  ],
  violence_shooting:[
    "shooting","gunman","attack","assassination","mass shooting","spree shooting",
    "politically motivated","gunshots","killed","injured","hospital","suicide",
    "gunfire","weapon","vehicle ramming","truck attack"
  ],
  protests_unrest:[
    "protest","demonstration","shooting during protest","dispersal order","chaotic scene",
    "unrest","riots","manhunt","curfew","state of emergency","looting","cover-up","abductions"
  ],
  safety_hazards:[
    "unsafe","hazardous","cladding","contamination","unsafe drinking water",
    "hazardous chemicals","toxin","biohazard","roof collapse","gas explosion","boat capsized"
  ]
};

const NEUTRAL_SECTIONS_DEFAULT = new Set(["news","latest","live","update","story","video","photo","photos","gallery","podcast","column","opinion","analysis","feature","weather","nation","politics","business","sports","technology","tech","style","travel","food","health","science","world","local","metro","arts","entertainment","maps","data","interactive"]);
const STOP_DEFAULT = new Set(["the","and","for","but","nor","with","that","this","from","into","onto","about","over","under","after","before","since","until","while","when","what","how","why","are","were","was","been","being","have","has","had","do","does","did","on","in","to","of","by","at","as","per","via","a","an","is","it","its","their","our","your"]);
const MONTHS = new Set(["january","february","march","april","may","june","july","august","september","october","november","december"]);
const WEEKDAYS = new Set(["monday","tuesday","wednesday","thursday","friday","saturday","sunday"]);
const THREE_EXCEPTIONS = new Set(["war","ban","gas","flu","pox","sex","gun","die"]);
const VOWELS = new Set(["a","e","i","o","u","y"]);
const runDemo = document.getElementById('runDemo');


async function loadLexicon(){
  try{
    const r = await fetch(`unsafe_lexicon_v1.json?v=1.1.0`, { cache: 'no-store' });
    if (!r.ok) throw new Error('no lex json');
    const j = await r.json();
    LEX = {
      UNSAFE: new Set(Object.values(j.unsafe).flat()),
      NEUTRAL: new Set(j.neutral_sections || [...NEUTRAL_SECTIONS_DEFAULT]),
      STOP: new Set(j.stopwords || [...STOP_DEFAULT]),
      allowBrands: new Set(j.allowlist_brands || []),
      allowLocs: new Set(j.allowlist_locations || []),
      settings: j.morphology || {}
    };
  }catch{
    LEX = {
      UNSAFE: new Set(Object.values(FALLBACK_UNSAFE).flat()),
      NEUTRAL: NEUTRAL_SECTIONS_DEFAULT,
      STOP: STOP_DEFAULT,
      allowBrands: new Set(),
      allowLocs: new Set(),
      settings: { split_delimiters:["/","-","_","."], scan_hostname:false, include_query:false }
    };
  }
}
loadLexicon();

/* ---------- State ---------- */
const state = {
  rows: [],        // {urls:[string], domain:string, impact:number}
  tokens: new Map(), // token -> {freq:number, impact:number, domains:Set, samples:string[], rows:Set}
  includedSet: new Set(),   // selected for output
  includedOrder: [],        // display order
  availableSet: new Set(),  // candidates not included
  availableOrder: [],       // display order (changes via sort and appends)
  autoIncluded: new Set(),  // from UNSAFE lexicon
  urlRegex: /https?:\/\/[^\s"']+/ig,
  metricLabel: 'Impact',
  searchAvail: '', 
  ignoreParams: new Set(["gclid","fbclid","mc_cid","mc_eid","utm_source","utm_medium","utm_campaign","utm_term","utm_content","utm_id","source","ref"])
};

state.urlImpact = new Map();

/* ---------- DOM ---------- */
const el = (s)=>document.querySelector(s);
const fileInput = el('#file');
const pasteInput = el('#paste');

const scanBtn = el('#scanBtn');
const rowCount = el('#rowCount');
const domainCount = el('#domainCount');
const tokenCount = el('#tokenCount');
const includedBox = el('#included');
const availableBox = el('#available');
const includedCount = el('#includedCount');
const availableCount = el('#availableCount');
const createBtn = el('#createBtn');
const outputPanel = el('#outputPanel');
const csvOut = el('#csvOut');
const blockedUrlCount = el('#blockedUrlCount');
const blockedImpact = el('#blockedImpact');
const blockedList = el('#blockedList');
const hoverBox = el('#hoverBox');

const minUrls = el('#minUrls');
const sortAvailable = el('#sortAvailable');
const impactCol = el('#impactCol');
const showAllAvail = el('#showAllAvail');
const availFilters = el('#availFilters');
const customKey = el('#customKey');
const addCustom = el('#addCustom');
const availSearch = document.getElementById('availSearch');

const dropZone = el('#dropZone');
const browseBtn = el('#browseBtn');
const dzTitle = dropZone ? dropZone.querySelector('.dz-title') : null;
const sortIncluded = el('#sortIncluded');
const includedSortLabel = el('#includedSortLabel');


function rebuildAvailable(){
  state.availableSet.clear();
  const umin = Number(minUrls.value)||1;
  for (const [tok, rec] of state.tokens){
    if (state.includedSet.has(tok)) continue;
    const urlCount = rec.urls ? rec.urls.size : 0;
    if (urlCount < umin) continue;
    state.availableSet.add(tok);
  }
  sortAndRenderAvailable();
  updateStats();
  updateAvailFilters();
  updateSectionTotals();
}


function updateAvailFilters(){
  const u = Number(minUrls.value)||1;
  const parts = [];
  if (u>1) parts.push(`≥${u} URLs`);
  const sortMap = { alpha:'Alphabetical', freq:'Frequency', impact:'Impact' };
  const s = sortMap[sortAvailable.value] || 'Impact';
  parts.push(`${s} ↓`);
  availFilters.textContent = parts.join(', ');
  const availSort = document.getElementById('availSort');
  if (availSort) availSort.textContent = ''; // keep spacing predictable (or remove this span)
}

function toNumber(v){
  if (typeof v === 'number') return v;
  const s = String(v ?? '').trim();
  if (!s) return NaN;
  const cleaned = s.replace(/,/g,'').replace(/^\((.*)\)$/,'-$1'); // "(123)"→-123
  const n = Number(cleaned);
  return Number.isFinite(n) ? n : NaN;
}
function getHeaderLabel(headers, i){
  const h = headers?.[i];
  const name = String(h ?? '').trim();
  return name || null;                 // null → we’ll fall back to "Impact"
}

function applyMetricLabel(){
  const lab = state.metricLabel || 'Impact';
  const el = document.getElementById('blockedImpactLabel');
  if (el) el.textContent = `Total ${lab} blocked:`;
}

function rebuildUrlImpact(){
  const m = new Map();
  for (const r of state.rows){
    const u = canonicalUrl(r.urls?.[0] || '');
    const v = Number(r.impact||0);
    if (!u) continue;
    m.set(u, (m.get(u)||0) + v);
  }
  state.urlImpact = m;
}


// --- Totals shown in headers ---
function updateSectionTotals(){
  const incEl = document.getElementById('includedImpactTotal');
  const availEl = document.getElementById('availableImpactTotal');
  if (!incEl && !availEl) return;

  // Build URL sets from tokens
  const incURLs = new Set();
  for (const tok of state.includedSet){
    const rec = state.tokens.get(tok);
    if (!rec || !rec.urls) continue;
    for (const u of rec.urls) incURLs.add(u);
  }
  const availURLsRaw = new Set();
  for (const tok of state.availableSet){
    const rec = state.tokens.get(tok);
    if (!rec || !rec.urls) continue;
    for (const u of rec.urls) availURLsRaw.add(u);
  }
  // Available = URLs hit by any available token, excluding ones already blocked by Included
  const availURLs = new Set();
  for (const u of availURLsRaw){ if (!incURLs.has(u)) availURLs.add(u); }

  // Sum impact once per URL using cache
  let incTotal = 0, availTotal = 0;
  for (const u of incURLs)     incTotal  += (state.urlImpact.get(u) || 0);
  for (const u of availURLs)   availTotal+= (state.urlImpact.get(u) || 0);

  const lab = state.metricLabel || 'Impact';
  if (incEl)   incEl.textContent   = `${lab}: ${incTotal.toLocaleString()}`;
  if (availEl) availEl.textContent = `${lab}: ${availTotal.toLocaleString()}`;
}


// --- Strict whole‑word matcher for blocked list ---
const _esc = s => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
function _buildIncludedWordRegex(){
  const terms = [...state.includedSet];
  if (!terms.length) return null;
  return new RegExp(`\\b(?:${terms.map(_esc).join('|')})\\b`, 'i');
}
function _rowText(row){
  const u = row?.urls?.[0] || '';
  try {
    const p = new URL(u).pathname || '';
    // treat -, _, / as word separators
    return p.toLowerCase().replace(/[-_/]+/g, ' ');
  } catch { return String(u).toLowerCase(); }
}



/* ---------- Utilities ---------- */
function asciiFold(s){
  return s.normalize ? s.normalize('NFKD').replace(/[\u0300-\u036f]/g,'') : s;
}
const NO_SINGULARIZE = new Set(['texas','news','us']); // extend as needed
function baseForm(tok){
  if (tok.endsWith('ies')) return tok.slice(0,-3)+'y';
  if (tok.endsWith('ves')) return tok.slice(0,-3)+'f';
  if (tok.endsWith('ing') && tok.length>5) return tok.slice(0,-3);
  if (tok.endsWith('ed')  && tok.length>4) return tok.slice(0,-2);
  // do NOT drop 's' for known exceptions or 'ss' endings
  if (tok.endsWith('s') && tok.length>3 && !tok.endsWith('ss') && !NO_SINGULARIZE.has(tok)) return tok.slice(0,-1);
  return tok;
}

function isAllHex(s){
  return /^[a-f]+$/.test(s);
}
function hexBias(s){
  if (!s) return 0;
  let k=0;
  for (const c of s) if ("abcdef".includes(c)) k++;
  return k/s.length;
}
function hasVowel(s){
  for (const c of s) if (VOWELS.has(c)) return true;
  return false;
}
function isRepetition(s){
  // repeated motif length 1..3 or any triple char
  if (/(.)\1\1/.test(s)) return true;
  for (let m=1;m<=3;m++){
    if (s.length % m === 0){
      const rep = s.slice(0,m).repeat(s.length/m);
      if (rep===s) return true;
    }
  }
  return false;
}
function uniqPush(arr, val, cap=10){
  if (arr.includes(val)) return;
  if (arr.length<cap) arr.push(val);
}
function byAlpha(a,b){ return a.localeCompare(b); }
function urlPath(u){
  try{
    const x = new URL(u);
    return (x.pathname || '/') + (x.search || '') + (x.hash || '');
  }catch{ return u; }
}

function canonicalUrl(u){
  try{
    const x = new URL(u);
    x.search = ''; x.hash = '';
    return x.toString().replace(/\/+$/,'');
  }catch{ return u; }
}

function closeHoverSticky(){
  if (stickyAnchor){ stickyAnchor.classList.remove('chip-active'); }
  stickyToken = null;
  stickyAnchor = null;
  hoverBox.style.display = 'none';
  hoverBox.removeAttribute('data-sticky');
}

// Click-to-copy for CSV output
(function initCopyCsv(){
  const box = document.getElementById('csvOutBox');
  const ta  = document.getElementById('csvOut');
  if (!box || !ta) return;

  // ensure readonly and non-focusable
  ta.readOnly = true;
  ta.setAttribute('aria-readonly','true');
  ta.setAttribute('tabindex','-1');

  box.addEventListener('click', async ()=>{
    const text = ta.value || '';
    try{
      await navigator.clipboard.writeText(text);
      box.classList.add('copied');
      setTimeout(()=>box.classList.remove('copied'), 900);
    }catch{
      // fallback: select and copy
      ta.removeAttribute('tabindex');
      ta.select();
      document.execCommand && document.execCommand('copy');
      ta.setAttribute('tabindex','-1');
      box.classList.add('copied');
      setTimeout(()=>box.classList.remove('copied'), 900);
      window.getSelection()?.removeAllRanges();
    }
  });
})();


function updateOutputMetrics(){
  const list = state.includedOrder.slice();
  const metricName = state.metricLabel || 'Impact';

  // empty state
  if (!state.rows.length || !list.length){
    const lbl = document.getElementById('blockedImpactLabel');
    if (lbl) lbl.textContent = `Total ${metricName} blocked:`;
    blockedUrlCount.textContent = '0';
    blockedImpact.textContent = '0';
    blockedList.innerHTML = '<div class="muted small">None</div>';
    return;
  }

  const urlImpact = new Map(); // canonical URL -> sum(metric)
  let total = 0;

  for (let i=0; i<state.rows.length; i++){
    const row = state.rows[i];
    if (!row) continue;

    // does any included term hit this row? compare via tableIdx
    let hit = false;
    for (const tok of list){
      const rec = state.tokens.get(tok);
      if (rec && rec.rows && rec.rows.has(row.tableIdx)){ hit = true; break; }
    }
    if (!hit) continue;

    const val = Number(row.impact||0);
    total += val;

    const u = canonicalUrl(row.urls[0]);
    urlImpact.set(u, (urlImpact.get(u)||0) + val);
  }

  // metrics
  blockedUrlCount.textContent = String(urlImpact.size);
  blockedImpact.textContent   = String(Math.round(total));
  const lbl = document.getElementById('blockedImpactLabel');
  if (lbl) lbl.textContent = `Total ${metricName} blocked:`;

  // list sorted by metric
  const sorted = Array.from(urlImpact.entries()).sort((a,b)=>b[1]-a[1]);
  blockedList.innerHTML = sorted.map(([u,val])=>`
    <div class="row">
      <span class="pill small">${metricName}&nbsp;<b>${Math.round(val)||0}</b></span>
      <a href="${u}" target="_blank" rel="noopener">${u}</a>
    </div>
  `).join('') || '<div class="muted small">None</div>';
}



/* ---------- Tokenization ---------- */
function extractUrlsFromRow(rowObj){
  const urls = new Set();
  // strings: search for http(s)://
  for (const v of Object.values(rowObj)){
    if (typeof v === 'string'){
      const matches = v.match(state.urlRegex);
      if (matches) for(const u of matches) urls.add(u);
    }
  }
  return [...urls];
}
function detectImpactColumn(headers, rows){
  // heuristic: find first numeric column with a friendly name
  const prefer = /(impressions|failed|blocked|views|view|qty|quantity|count|volume|reach|exposure)/i;
  let candidates = [];
  headers.forEach((h,i)=>{
    let numeric = 0, total = 0;
    for (const r of rows){
      const v = r[i];
      if (typeof v === 'number' && !Number.isNaN(v)){ numeric++; total++; }
      else if (typeof v === 'string' && v.trim()!=='' && !isNaN(Number(v))){ numeric++; total++; }
      else if (v==='' || v==null){ total++; }
      else { total++; }
    }
    if (numeric>0) candidates.push({index:i, header:h, score:(prefer.test(h)?2:1)+numeric/Math.max(1,rows.length)});
  });
  candidates.sort((a,b)=>b.score-a.score);
  return candidates[0] || null;
}
function normalizeTokensFromUrl(u, opts){
  let url;
  try{ url = new URL(u); }catch{ return []; }
  const set = new Set();

  let path = decodeURIComponent(url.pathname||'');
  const parts = path.split(/[\/\-_\.]+/);
  for (let p of parts) set.add(p);

  // Clean and filter
  const out = [];
  for (let t of set){
    t = asciiFold(String(t||'').toLowerCase());
    t = t.replace(/[^a-z\-]/g,'');           // letters and hyphen only
    if (!t) continue;
    if (LEX.NEUTRAL.has(t) || LEX.STOP.has(t) || MONTHS.has(t) || WEEKDAYS.has(t)) continue;
    if (LEX.allowBrands.has(t) || LEX.allowLocs.has(t)) continue;
    // if contains hyphen, also split into pieces so both "los-angeles" and "los","angeles" can appear
    const candidates = t.includes('-') ? [t, ...t.split('-')] : [t];
    for (let c of candidates){
      c = c.replace(/[^a-z]/g,'');
      if (!c) continue;
      let base = baseForm(c);
      // length rules
      if (base.length<4 && !THREE_EXCEPTIONS.has(base)) continue;
      if (base.length>24) continue;
      // noise rules
      if (!hasVowel(base) && !LEX.UNSAFE.has(base) && !THREE_EXCEPTIONS.has(base)) continue;
      if (isRepetition(base)) continue;
      if (isAllHex(base) || hexBias(base)>=0.8) continue;
      out.push(base);
    }
  }
  return [...new Set(out)];
}

async function loadDemoFile(url, name){
  // Fetch demo file
  const res = await fetch(url, {cache:'no-store'});
  if (!res.ok) throw new Error(`Demo file not found: ${url}`);
  const blob = await res.blob();

  // Build a File and assign to the <input type="file">
  const fname = name || url.split('/').pop() || 'demo.csv';
  const mime  = fname.toLowerCase().endsWith('.xlsx') ? 
                  'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' : 
                  'text/csv';
  const file  = new File([blob], fname, { type: mime, lastModified: Date.now() });

  const dT = new DataTransfer();
  dT.items.add(file);
  fileInput.files = dT.files;

  // Update the small file chip row and run the normal pipeline
  updateFileUI && updateFileUI();
  await parseInput();
}

/* ---------- Parsing pipeline ---------- */
    async function parseInput(){
    if (!LEX) await loadLexicon();

    function parseCSV(text){
        const rows=[]; let row=[], field='', inQ=false;
        for (let i=0;i<text.length;i++){
        const c=text[i], n=text[i+1];
        if (inQ){
            if (c==='"' && n==='"'){ field+='"'; i++; continue; }
            if (c==='"'){ inQ=false; continue; }
            field+=c; continue;
        }
        if (c==='"'){ inQ=true; continue; }
        if (c===','){ row.push(field); field=''; continue; }
        if (c==='\r'){ continue; }
        if (c==='\n'){ row.push(field); rows.push(row); row=[]; field=''; continue; }
        field+=c;
        }
        row.push(field); rows.push(row);
        return rows;
    }

    // reset
    state.rows = [];
    state.tokens.clear();
    state.includedSet.clear(); state.includedOrder.length=0;
    state.availableSet.clear(); state.availableOrder.length=0;
    state.autoIncluded.clear();

    let headers = [];
    let tableRows = [];

    // file
    if (fileInput.files && fileInput.files[0]){
    const f = fileInput.files[0];
    const name = f.name.toLowerCase();

    if (name.endsWith('.xlsx') || name.endsWith('.xls')){
        const ok = await ensureXLSX();
        if (!ok){ alert('XLSX parsing unavailable. Add ./lib/xlsx.full.min.js or upload CSV.'); updateStats(); render(); return; }
        const buf = await f.arrayBuffer();
        const wb = XLSX.read(buf, {type:'array'});

        let canonHeader = null;
        wb.SheetNames.forEach(sname=>{
        const sh = wb.Sheets[sname];
        const A = XLSX.utils.sheet_to_json(sh, {header:1, raw:true, defval:''});
        if (!A.length) return;
        const h = A[0].map(x=>String(x??'').trim());
        const rows = A.slice(1);

        if (!canonHeader){                    // pick the first non-empty header as canonical
            canonHeader = h.slice();
            headers = h.slice();
        }

        // only accept sheets whose header exactly matches the canonical header
        if (h.length !== canonHeader.length || h.join('\u0001') !== canonHeader.join('\u0001')) return;

        for (const r of rows){ while (r.length<headers.length) r.push(''); }
        tableRows.push(...rows);
        });

    } else {
        const text = await f.text();
        const arr = parseCSV(text);
        if (arr.length){
        headers = arr[0].map(x=>String(x??'').trim());
        const rows = arr.slice(1);
        for (const r of rows){ while (r.length<headers.length) r.push(''); }
        tableRows.push(...rows);
        }
    }
    }


    // paste
    const pasted = pasteInput.value.trim();
    if (pasted){
        const looksCSV = /,|".*?".*[,|\n]/s.test(pasted);
        if (looksCSV){
        const arr = parseCSV(pasted);
        if (arr.length){
            const h = arr[0].map(x=>String(x??''));
            const rows = arr.slice(1);
            if (!headers.length) headers = h;
            for (const r of rows){ while (r.length<headers.length) r.push(''); }
            tableRows.push(...rows);
        }
        }else{
        const h = ['url'];
        const rows = pasted.split(/\r?\n/).map(l=>[l.trim()]);
        if (!headers.length) headers = h;
        tableRows.push(...rows);
        }
    }

    if (!headers.length && !tableRows.length){ updateStats(); return; }

    const headerLabels = headers.map(h => String(h ?? '').trim());

    // ---- Impact column detection (only numeric-eligible columns) ----
        function toNumber(v){
    if (typeof v === 'number') return v;
    const s = String(v ?? '').trim();
    if (!s) return NaN;
    const cleaned = s.replace(/,/g,'').replace(/^\((.*)\)$/,'-$1'); // "(123)" -> -123
    const n = Number(cleaned);
    return Number.isFinite(n) ? n : NaN;
    }

    function analyzeNumericColumns(headers, rows){
    const prefer = /(impressions|failed|blocked|views|view|qty|quantity|count|volume|reach|exposure|clicks|spent|spend)/i;
    const out=[];
    headers.forEach((_, i)=>{
        const label = getHeaderLabel(headers, i) || `Column ${i+1}`;
        let numeric=0, checked=0;
        for (let k=0;k<Math.min(300, rows.length);k++){
        const n = toNumber(rows[k][i]);
        if (!Number.isNaN(n)) numeric++;
        checked++;
        }
        if (numeric>0){
        const frac = numeric/Math.max(1,checked);
        out.push({ i, label, frac, score:(prefer.test(label)?2:1)+frac });
        }
    });
    out.sort((a,b)=>b.score-a.score);
    return out;
    }



    let impactIdx = null;
    const numericEligible = analyzeNumericColumns(headerLabels, tableRows);
    if (numericEligible.length){
    impactIdx = numericEligible[0].i;
    const top = numericEligible[0];
    const opts = [`<option value="">Auto (${top.label})</option>`]
        .concat(numericEligible.map(c=>`<option value="${c.i}">${c.label}</option>`));
    impactCol.innerHTML = opts.join('');
    impactCol.disabled = false;
    impactCol.value = '';                                 // Auto = best column
    state.metricLabel = getHeaderLabel(headerLabels, impactIdx) || 'Impact';
    } else {
    impactCol.innerHTML = `<option value="">Auto (none)</option>`;
    impactCol.disabled = true;
    impactIdx = null;
    state.metricLabel = 'Impact';
    }


    // detect URL/keyword columns
    const urlCols = new Set();
        for (let i=0;i<headers.length;i++){
        let hits=0;
        for (let k=0;k<Math.min(50, tableRows.length);k++){
            const cell = tableRows[k][i];
            if (typeof cell==='string' && /https?:\/\//i.test(cell)) hits++;
        }
        if (hits>0) urlCols.add(i);
        }

    const keyCols = new Set();
    headers.forEach((h,i)=>{ if (/keyword|segment|tag|topic/i.test(h)) keyCols.add(i); });

    const opts = { scanHost:false, includeQuery:false };

    // rows → tokens
    tableRows.forEach((arr, idx)=>{
    const obj = {}; headers.forEach((h,i)=>obj[h]=arr[i]);

    // collect URLs from detected URL columns, else from any string cell
    let urls = [];
    if (urlCols.size){
        for (const c of urlCols){
        const v = arr[c];
        if (typeof v==='string'){
            const m = v.match(state.urlRegex);
            if (m) urls.push(...m);
        }
        }
    }else{
        for (const v of Object.values(obj)){
        if (typeof v==='string'){
            const m = v.match(state.urlRegex);
            if (m) urls.push(...m);
        }
        }
    }
    if (!urls.length){
        for (const v of arr){
        if (typeof v==='string' && /^https?:\/\//i.test(v.trim())) urls.push(v.trim());
        }
    }
    if (!urls.length) return;

    const primary = urls[0];
    let domain = '';
    try{ domain = new URL(primary).hostname.replace(/^www\./,''); }catch{}
    let imp = 0;
    const chosenIdx = (impactCol.value!=='' ? Number(impactCol.value) : impactIdx);
    if (chosenIdx != null){
    const num = toNumber(arr[chosenIdx]);
    if (!Number.isNaN(num)) imp = num;
    }
    // if user chose a specific column, update the label immediately
    if (impactCol.value !== ''){
    const chosen = Number(impactCol.value);
    state.metricLabel = getHeaderLabel(headerLabels, chosen) || 'Impact';
    }



    /* ---------- tokens ---------- */
    // Count unique URLs per term. Keywords affect row presence but not URL count.
    const perRowTokenSet = new Set(); // tokens present anywhere in this row

    // from URLs → add unique canonical URL per token
    for (const u of urls){
    const can = canonicalUrl(u);
    const toksArr = normalizeTokensFromUrl(u, opts);
    const uniq = new Set(toksArr);
    for (const t of uniq){
        if (!state.tokens.has(t)){
        state.tokens.set(t, {freq:0, impact:0, domains:new Set(), samples:[], rows:new Set(), urls:new Set()});
        }
        const rec = state.tokens.get(t);
        rec.urls.add(can);              // canonical for counting
        perRowTokenSet.add(t);          // row presence
    }
    }

    // from keyword-like columns → row presence only
    for (const c of keyCols){
    const v = arr[c];
    if (typeof v === 'string' && v.trim()){
        v.split(/[,;\|]+/).forEach(piece=>{
        const toks2 = normalizeTokensFromUrl(String(piece), {scanHost:false, includeQuery:false});
        for (const t of new Set(toks2)) perRowTokenSet.add(t);
        });
    }
    }

/* ---------- update token map ---------- */


    /* ---------- update token map ---------- */
    for (const tok of perRowTokenSet){
        if (!state.tokens.has(tok)){
        state.tokens.set(tok, {freq:0, impact:0, domains:new Set(), samples:[], rows:new Set(), urls:new Set()});
        }
        const rec = state.tokens.get(tok);
        rec.freq += 1;              // row presence (not shown in chip)
        rec.impact += imp;          // shown as “Imps.”
        rec.domains.add(domain || '(unknown)');
        uniqPush(rec.samples, primary, 10);
        rec.rows.add(idx);
    }

    state.rows.push({urls, domain, impact: imp, tableIdx: idx});
    });

    // finalize included and available
    // auto-include from lexicon
    // auto-include from lexicon
    for (const [tok] of state.tokens){
    if (LEX.UNSAFE.has(tok)){
        state.includedSet.add(tok);
        state.autoIncluded.add(tok);
    }
    }
    // sort Included by current setting, then build Available
    rebuildUrlImpact();  
    sortAndRenderIncluded();
    rebuildAvailable();
    updateStats();
    applyMetricLabel();
    toggleEmptyState();
    outputPanel.style.display = 'block';
    updateOutputMetrics();
    createBtn.disabled = state.rows.length === 0;
    createBtn.title = state.rows.length ? '' : 'Upload data first';
    // show search only if a real XLSX/XLS file is loaded
    const f = fileInput.files && fileInput.files[0];
    const isXlsx = !!(f && /\.(xlsx|xls)$/i.test(f.name||''));
    if (availSearch){
      availSearch.hidden = !isXlsx;
      if (!isXlsx){ availSearch.value=''; state.searchAvail=''; }
    }
    rebuildUrlImpact();  // keep this call if you added it earlier
    recomputeBlocked();
    }

    function sortAndRenderAvailable(){
    const criterion = sortAvailable.value; // 'alpha' | 'freq' | 'impact'
    const q = (state.searchAvail||'').toLowerCase();

    let list = Array.from(state.availableSet);
    if (q) list = list.filter(t => t.toLowerCase().includes(q));

    list.sort((a,b)=>{
      if (criterion==='alpha') return a.localeCompare(b);
      if (criterion==='freq')  return (state.tokens.get(b).freq - state.tokens.get(a).freq) || a.localeCompare(b);
      return (state.tokens.get(b).impact - state.tokens.get(a).impact) || a.localeCompare(b);
    });

    state.availableOrder = list;
    render();
  }


function sortAndRenderIncluded(){
  const criterion = sortIncluded.value; // 'alpha' | 'impact' | 'freq'
  const list = Array.from(state.includedSet);
  list.sort((a,b)=>{
    if (criterion==='alpha') return a.localeCompare(b);
    const ra = state.tokens.get(a) || {};
    const rb = state.tokens.get(b) || {};
    const aImp = ra.impact|0, bImp = rb.impact|0;
    const aURLs = ra.urls ? ra.urls.size : 0;
    const bURLs = rb.urls ? rb.urls.size : 0;
    if (criterion==='impact') return (bImp - aImp) || a.localeCompare(b);
    if (criterion==='freq')   return (bURLs - aURLs) || a.localeCompare(b);
    return a.localeCompare(b);
  });
  state.includedOrder = list;
  render();
  updateIncludedSortLabel();
  updateSectionTotals();
}

sortIncluded.addEventListener('change', sortAndRenderIncluded);

function updateIncludedSortLabel(){
  const map = { alpha:'Alphabetical', impact:'Impact', freq:'Frequency' };
  if (includedSortLabel) includedSortLabel.textContent = `${map[sortIncluded.value]||'Alphabetical'} ↓`;
}


/* ---------- Render ---------- */
function updateStats(){
  rowCount.textContent = String(state.rows.length);
  const domains = new Set(state.rows.map(r=>r.domain));
  domainCount.textContent = String(domains.size);
  tokenCount.textContent = String(state.tokens.size);
}
function chipHTML(tok, rec, kind){
  const auto = state.autoIncluded.has(tok);
  const urls = rec?.urls ? rec.urls.size : 0;
  const valLabel = state.metricLabel || 'Impact';
  const val = rec?.impact ? (rec.impact|0) : 0;
  const cls = ['chip', kind==='included' && auto ? 'auto':'', kind==='available' && rec && rec._recent ? 'recent':''].filter(Boolean).join(' ');
  const btn = kind==='included' ? '×' : '+';
  const title = kind==='included' ? 'Remove' : 'Add';
  return `<span class="${cls}" data-token="${tok}" data-kind="${kind}">
    <b>${tok}</b>
    <small class="muted" title="URLs">URLs: ${urls}</small>
    <small class="muted" title="${valLabel}">${valLabel}: ${val}</small>
    <button class="btn" aria-label="${title}" data-act="${kind==='included'?'remove':'add'}">${btn}</button>
  </span>`;
}


function render(){
  // included
  includedBox.innerHTML = state.includedOrder.map(t=>chipHTML(t, state.tokens.get(t), 'included')).join('');
  includedCount.textContent = String(state.includedOrder.length);

  // available
  const nodes = [];
  for (const t of state.availableOrder){
    const rec = state.tokens.get(t);
    nodes.push(chipHTML(t, rec, 'available'));
  }
  availableBox.innerHTML = nodes.join('');
  availableCount.textContent = String(state.availableOrder.length);
  updateOutputMetrics();
  updateSectionTotals();

    // reconcile sticky after DOM changes
    if (stickyToken){
    const fresh = document.querySelector(`.chip[data-token="${stickyToken}"]`);
    if (fresh && document.body.contains(fresh)){
      if (stickyAnchor !== fresh){
        if (stickyAnchor) stickyAnchor.classList.remove('chip-active');
        stickyAnchor = fresh;
        stickyAnchor.classList.add('chip-active');
        positionHover(stickyAnchor);
      }
    } else {
      closeHoverSticky();
    }
  }

}

/* ---------- Interactions ---------- */
scanBtn.addEventListener('click', parseInput);

runDemo?.addEventListener('click', async ()=>{
  try{
    await loadDemoFile('./assets/blocklist-demo-urls.csv', 'blocklist-demo-urls.csv');
  }catch(err){
    alert('Could not load demo.\n\n' + (err?.message || err));
  }
});


minUrls.addEventListener('change', rebuildAvailable);
sortAvailable.addEventListener('change', ()=>{
  sortAndRenderAvailable();
  updateAvailFilters();
});

availSearch?.addEventListener('input', ()=>{
  state.searchAvail = availSearch.value.trim().toLowerCase();
  sortAndRenderAvailable();
});

const addAllAvailBtn = document.getElementById('addAllAvail');
addAllAvailBtn?.addEventListener('click', ()=>{
  closeHoverSticky?.();

  const target = state.searchAvail
    ? state.availableOrder.slice()                 // filtered subset
    : Array.from(state.availableSet);              // all available

  for (const tok of target){
    if (state.availableSet.delete(tok)){
      state.includedSet.add(tok);
    }
  }
  sortAndRenderIncluded();
  sortAndRenderAvailable();
  render();
  recomputeBlocked();
});


window.addEventListener('scroll', ()=>{
  if (stickyToken && stickyAnchor && document.body.contains(stickyAnchor)){
    positionHover(stickyAnchor);
  } else {
    closeHoverSticky();
  }
});
window.addEventListener('resize', ()=>{
  if (stickyToken && stickyAnchor && document.body.contains(stickyAnchor)){
    positionHover(stickyAnchor);
  } else {
    closeHoverSticky();
  }
});


impactCol.addEventListener('change', parseInput);
// Show all / Collapse without touching Included
let prevMinUrls = 2;
showAllAvail.addEventListener('click', ()=>{
  const mode = showAllAvail.getAttribute('data-mode') || 'all';
  if (mode === 'all'){
    prevMinUrls = Number(minUrls.value)||2;
    minUrls.value = 1;
    showAllAvail.textContent = 'Collapse';
    showAllAvail.setAttribute('data-mode','collapse');
  }else{
    minUrls.value = prevMinUrls ?? 2;
    showAllAvail.textContent = 'Show all';
    showAllAvail.setAttribute('data-mode','all');
  }
  rebuildAvailable();
});

addCustom.addEventListener('click', ()=>{
  const v = customKey.value.trim().toLowerCase();
  if (!v) return;
  const base = v.replace(/[^a-z\-]/g,'');
  if (!base) return;

  if (!state.includedSet.has(base)){
    state.includedSet.add(base);
    state.includedOrder.push(base);
    if (state.availableSet.delete(base)){
      const i = state.availableOrder.indexOf(base);
      if (i>=0) state.availableOrder.splice(i,1);
    }
    render();
    recomputeBlocked();
  }
  customKey.value = '';
});


includedBox.addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-act="remove"]');
  if (!btn) return;
  closeHoverSticky();
  const chip = btn.closest('.chip');
  const tok = chip.getAttribute('data-token');
  if (state.includedSet.delete(tok)){
    const i = state.includedOrder.indexOf(tok);
    if (i>=0) state.includedOrder.splice(i,1);
  }
  state.availableSet.add(tok);
  const rec = state.tokens.get(tok); if (rec) rec._recent = true;
  state.availableOrder.push(tok);
  sortAndRenderIncluded();
  render();
  recomputeBlocked();
});

availableBox.addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-act="add"]');
  if (!btn) return;
  closeHoverSticky();
  const chip = e.target.closest('.chip');
  const tok = chip.getAttribute('data-token');
  if (!state.includedSet.has(tok)){
    state.includedSet.add(tok);
  }
  if (state.availableSet.delete(tok)){
    const i = state.availableOrder.indexOf(tok);
    if (i>=0) state.availableOrder.splice(i,1);
  }
  sortAndRenderIncluded();
  render();
  recomputeBlocked();
});


/* ---------- Hover details ---------- */
let stickyToken = null;
let stickyAnchor = null;

function positionHover(anchorEl){
  const rect = anchorEl.getBoundingClientRect();
  hoverBox.style.left = Math.min(window.innerWidth-560, rect.left) + 'px';
  hoverBox.style.top  = (window.scrollY + rect.bottom + 6) + 'px';
}

function showHover(token, anchorEl, makeSticky=false){
  const rec = state.tokens.get(token);
  if (!rec) return;

  const urlsSet   = rec.urls || new Set();
  const urlsCount = urlsSet.size;
  const metric    = state.metricLabel || 'Impact';
  const metricVal = rec.impact | 0;

  const paths = Array.from(urlsSet).slice(0,10)  // cap at 10
    .map(u=>({ href:u, text:urlPath(u) }));

  hoverBox.innerHTML = `
    <div class="row" style="margin-bottom:6px">
      <b>${token}</b>
      <span class="pill small">URLs: <b>${urlsCount}</b></span>
      <span class="pill small">${metric}: <b>${metricVal}</b></span>
    </div>
    <div class="small muted">Sample Paths (Max 10)</div>
    <div class="list">
      ${paths.map(p=>`<a href="${p.href}" target="_blank" rel="noopener">${p.text || p.href}</a>`).join('')}
    </div>
  `;

  const rect = anchorEl.getBoundingClientRect();
  hoverBox.style.left = Math.min(window.innerWidth-560, rect.left) + 'px';
  hoverBox.style.top  = (window.scrollY + rect.bottom + 6) + 'px';
  hoverBox.style.display = 'block';

  if (makeSticky){
    stickyToken = token;
    stickyAnchor = anchorEl;
    hoverBox.setAttribute('data-sticky','1');
    anchorEl.classList.add('chip-active');
  } else {
    hoverBox.removeAttribute('data-sticky');
  }
}


function hideHover(){
  if (stickyToken) return;
  hoverBox.style.display = 'none';
}

// hover preview when not sticky
document.addEventListener('mouseover', (e)=>{
  if (stickyToken) return;
  const chip = e.target.closest('.chip');
  if (chip && (chip.parentElement===includedBox || chip.parentElement===availableBox)){
    const t = chip.getAttribute('data-token');
    showHover(t, chip, false);
  }else{
    hideHover();
  }
});

// click anywhere on chip except +/× to toggle sticky
function chipToggleSticky(e){
  const chip = e.target.closest('.chip');
  if (!chip) return;
  if (e.target.closest('button[data-act]')) return; // let add/remove work
  const tok = chip.getAttribute('data-token');
  if (stickyToken === tok){
    stickyToken = null; 
    if (stickyAnchor){ stickyAnchor.classList.remove('chip-active'); }
    stickyAnchor = null;
    hoverBox.style.display = 'none';
    hoverBox.removeAttribute('data-sticky');
  }else{
    if (stickyAnchor){ stickyAnchor.classList.remove('chip-active'); }
    stickyToken = tok;
    stickyAnchor = chip;
    showHover(tok, chip, true);
  }
}
includedBox.addEventListener('click', chipToggleSticky);
availableBox.addEventListener('click', chipToggleSticky);

// click outside to close sticky
document.addEventListener('click', (e)=>{
  if (!stickyToken) return;
  if (e.target.closest('#hoverBox') || e.target.closest('.chip')) return;
  if (stickyAnchor){ stickyAnchor.classList.remove('chip-active'); }
  stickyToken = null; stickyAnchor = null;
  hoverBox.style.display = 'none';
  hoverBox.removeAttribute('data-sticky');
});

// keep sticky positioned
window.addEventListener('scroll', ()=>{ if (stickyToken && stickyAnchor) positionHover(stickyAnchor); else hideHover(); });
window.addEventListener('resize', ()=>{ if (stickyToken && stickyAnchor) positionHover(stickyAnchor); else hideHover(); });

/* ---------- Recompute blocked metrics (Unique URLs + Total metric) ---------- */
function recomputeBlocked(){
  const rx = _buildIncludedWordRegex();
  const urlImpact = new Map();
  let total = 0;

  const metricName =
    state.metricLabel ||
    (impactCol && impactCol.value !== '' ? (impactCol.options[impactCol.selectedIndex]?.text?.trim() || 'Impact') : 'Impact');

  if (!rx || !state.rows.length){
    blockedUrlCount.textContent = '0';
    blockedImpact.textContent = '0';
    const lbl = document.getElementById('blockedImpactLabel');
    if (lbl) lbl.textContent = `Total ${metricName} blocked:`;
    blockedList.innerHTML = '<div class="muted small">None</div>';
    updateSectionTotals();
    return;
  }

  for (let i=0; i<state.rows.length; i++){
    const row = state.rows[i];
    const text = _rowText(row);
    if (!rx.test(text)) continue;

    const val = Number(row.impact||0);
    total += val;

    const u = canonicalUrl(row.urls[0]);
    urlImpact.set(u, (urlImpact.get(u)||0) + val);
  }

  blockedUrlCount.textContent = String(urlImpact.size);
  blockedImpact.textContent   = String(Math.round(total));
  const lbl = document.getElementById('blockedImpactLabel');
  if (lbl) lbl.textContent = `Total ${metricName} blocked:`;

  const sorted = Array.from(urlImpact.entries()).sort((a,b)=>b[1]-a[1]);
  blockedList.innerHTML = sorted.map(([u,val])=>`
    <div class="row">
      <span class="pill small">${metricName}&nbsp;<b>${Math.round(val)||0}</b></span>
      <a href="${u}" target="_blank" rel="noopener">${u}</a>
    </div>
  `).join('') || '<div class="muted small">None</div>';

  updateSectionTotals();
}


/* ---------- Copy/Export handler ---------- */
createBtn.addEventListener('click', ()=>{
  csvOut.value = state.includedOrder.join(',');
  outputPanel.style.display = 'block';
  outputPanel.scrollIntoView({behavior:'smooth', block:'start'});
});

// Dropzone + file UI
function updateFileUI(){
  // ensure the compact row exists
  let fileRow = document.getElementById('fileNameRow');
  if (!fileRow){
    fileRow = document.createElement('div');
    fileRow.id = 'fileNameRow';
    fileRow.className = 'filechip';
    fileRow.style.display = 'none';
    dropZone.parentElement.insertBefore(fileRow, dropZone.nextSibling);
  }

  const f = fileInput.files && fileInput.files[0];

  if (!f){
    dropZone.style.display = '';                          // show dropzone
    if (dzTitle) dzTitle.innerHTML = '<b>Browse or drop CSV/XLSX here</b>';
    fileRow.style.display = 'none';
    return;
  }

  const size = (f.size/1024/1024).toFixed(2)+' MB';
  dropZone.style.display = 'none';                        // hide dropzone
  fileRow.innerHTML =
  `<span class="name">${f.name}</span>
   <span class="size">(${size})</span>
   <button class="btn small" id="clearFileBtn">Clear</button>`;
  fileRow.style.display = '';
}

document.addEventListener('click', (e)=>{
  if (e.target && e.target.id === 'changeFileBtn'){
    fileInput.click();
  }
});

// browse + click to open
if (browseBtn) browseBtn.addEventListener('click', (e)=>{ e.stopPropagation(); fileInput.click(); });
if (dropZone) dropZone.addEventListener('click', ()=> fileInput.click());
if (fileInput) fileInput.addEventListener('change', updateFileUI);

// drag & drop (single authoritative handler)
if (dropZone){
  ['dragenter','dragover'].forEach(ev=>{
    dropZone.addEventListener(ev, e=>{
      e.preventDefault();
      e.dataTransfer.dropEffect='copy';
      dropZone.classList.add('dragover');
    });
  });
  ['dragleave','drop'].forEach(ev=>{
    dropZone.addEventListener(ev, e=>{
      e.preventDefault();
      dropZone.classList.remove('dragover');
    });
  });
  dropZone.addEventListener('drop', e=>{
    const dt = e.dataTransfer;
    if (!dt) return;

    if (dt.files && dt.files.length){
      // assign via DataTransfer so 'change' is honored across browsers
      const dT = new DataTransfer();
      dT.items.add(dt.files[0]);
      fileInput.files = dT.files;
      updateFileUI();
      return;
    }

    // support dropping text/URLs
    const text = dt.getData('text') || dt.getData('text/plain');
    if (text) pasteInput.value = (pasteInput.value?pasteInput.value+'\n':'') + text.trim();
  });
}

// delegate the "Change" button
document.addEventListener('click', (e)=>{
  if (e.target && e.target.id === 'clearFileBtn'){
    fileInput.value = '';
    updateFileUI();
    if (csvOut) csvOut.value = '';     // <- add
    if (typeof resetAll === 'function') resetAll();
  }
});

(function syncBarHeight(){
  const bar = document.querySelector('.appbar');
  if (!bar) return;
  const set = ()=> document.documentElement
    .style.setProperty('--bar-h', bar.offsetHeight + 'px');
  set();
  new ResizeObserver(set).observe(bar);
  window.addEventListener('resize', set);
})();

    function resetAll(){
    // clear UI inputs
    const fileInputEl = document.getElementById('file');
    const pasteEl = document.getElementById('paste');
    if (fileInputEl) fileInputEl.value = '';
    if (pasteEl) pasteEl.value = '';
    if (availSearch){ availSearch.hidden = true; availSearch.value=''; }
    state.searchAvail = '';

    createBtn.disabled = true;
    createBtn.title = 'Upload data first';

    // clear computed state
    state.rows = [];
    state.tokens.clear();
    state.includedSet.clear(); state.includedOrder.length=0;
    state.availableSet.clear(); state.availableOrder.length=0;
    state.autoIncluded.clear();

    // defaults for controls
    minUrls.value = 2;
    showAllAvail.textContent = 'Show all';
    showAllAvail.setAttribute('data-mode','all');
    updateAvailFilters?.();

    // counters and panels
    rowCount.textContent = '0';
    domainCount.textContent = '0';
    tokenCount.textContent = '0';
    included.innerHTML = '';
    available.innerHTML = '';
    if (includedCount)  includedCount.textContent = '0';
    if (availableCount) availableCount.textContent = '0';
    if (csvOut) csvOut.value = '';
    blockedUrlCount.textContent = '0';
    blockedImpact.textContent   = '0';
    const lbl = document.getElementById('blockedImpactLabel');
    if (lbl) lbl.textContent = `Total ${(state.metricLabel||'Impact')} blocked:`;
    outputPanel.style.display = 'none';

    updateFileUI && updateFileUI();
    toggleEmptyState();
    state.urlImpact = new Map();
    updateSectionTotals?.();
    }

// run on initial load and BFCache restores
    window.addEventListener('DOMContentLoaded', resetAll);

    window.addEventListener('pageshow', (e)=>{ if (e.persisted) resetAll(); });

    document.addEventListener('DOMContentLoaded', ()=>{
    const backTop = document.getElementById('backTop');
    if (!backTop) return;

    const toggle = ()=>{
        if (window.scrollY > 400) backTop.classList.add('show');
        else backTop.classList.remove('show');
    };
    window.addEventListener('scroll', toggle, {passive:true});
    toggle(); // run once on load

    backTop.addEventListener('click', ()=> window.scrollTo({top:0, behavior:'smooth'}));
    });

    (function adjustBarOffset(){
  const h = document.querySelector('header');
  if (!h) return;
  const set = ()=> document.documentElement.style.setProperty('--bar-h', h.offsetHeight+'px');
  set();
  window.addEventListener('resize', set, {passive:true});
})();

    // button hover -> parent chip intent class
    includedBox.addEventListener('mouseover', (e)=>{
    const btn  = e.target.closest('button[data-act]');
    const chip = e.target.closest('.chip');
    if (!chip) return;
    chip.classList.remove('will-add','will-remove');
    chip.classList.toggle('hover-soft', !btn);           // light blue when not over +/- 
    if (btn && btn.dataset.act==='remove') chip.classList.add('will-remove');
  });
  includedBox.addEventListener('mouseout', e=>{
    const chip = e.target.closest('.chip');
    if (chip) chip.classList.remove('will-add','will-remove','hover-soft');
  });

    availableBox.addEventListener('mouseover', (e)=>{
    const btn  = e.target.closest('button[data-act]');
    const chip = e.target.closest('.chip');
    if (!chip) return;
    chip.classList.remove('will-add','will-remove');
    chip.classList.toggle('hover-soft', !btn);           // light blue when not over +/- 
    if (btn && btn.dataset.act==='add') chip.classList.add('will-add');
  });
  availableBox.addEventListener('mouseout', e=>{
    const chip = e.target.closest('.chip');
    if (chip) chip.classList.remove('will-add','will-remove','hover-soft');
  });


    document.addEventListener('DOMContentLoaded', ()=>{
      const minWidth = 980; // was 1024
      const overlay = document.getElementById('viewportOverlay');
      if (!overlay) return;
      const check = ()=>{ overlay.style.display = (window.innerWidth < minWidth) ? 'flex' : 'none'; };
      window.addEventListener('resize', check, {passive:true});
      check();
    });



/* ---------- Ready ---------- */
</script>
<button id="backTop" aria-label="Back to top" title="Back to top">↑ Top</button>
<footer class="footer">
    <div class="bar">
      <span>© <span id="year"></span> Colin Bingham</span>
      <a class="link" href="https://www.colinbing.com" target="_blank" rel="noopener">Back to site</a>
    </div>
    <script>document.getElementById('year').textContent = new Date().getFullYear();</script>
  </footer>  

  <div id="viewportOverlay" style="
  display:none;position:fixed;inset:0;z-index:99999;
  background:rgba(0,0,0,0.85);color:#fff;
  font-family:sans-serif;font-size:18px;
  align-items:center;justify-content:center;text-align:center;padding:2rem;
">
  <div>
    <h2 style="margin-bottom:0.5em">Screen too small</h2>
    <p>Please use this tool on a larger screen for the best experience.<br>
    Minimum width: 980 px</p>
  </div>
</div>

</body>
</html>
